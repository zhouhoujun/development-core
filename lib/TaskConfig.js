"use strict";function task(e){Object.seal(e),Object.seal(e.prototype)}function bindingConfig(e){return e.fileFilter=e.fileFilter||files,e.runSequence=e.runSequence||runSequence,e.addTask=e.addTask||addTask,e.generateTask=e.generateTask||function(r){return generateTask(r,e.oper,e.env)},e.subTaskName=e.subTaskName||function(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return e.option.name?e.option.name+"-"+(r||n):r},e.getDist=e.getDist||function(r){if(r){var n=getCurrentDist(r,e.oper);if(n)return n}return getCurrentDist(e.option,e.oper)},e}function currentOperation(e){var r=void 0;return r=e.deploy?Operation.deploy:e.release?Operation.release:e.e2e?Operation.e2e:e.test?Operation.test:Operation.build}function toSequence(e,r){var n=[];e=_.filter(e,function(e){return e});var t=e.length;return e=_.orderBy(e,function(e){return e?_.isString(e)?t:_.isArray(e)?t:e.order:t}),_.each(e,function(e){e&&(_.isString(e)?n.push(e):_.isArray(e)?n.push(_.flatten(toSequence(e,r))):e.name&&(e.oper?(e.oper&r)>0&&n.push(e.name):n.push(e.name)))}),n}function runSequence(e,r){var n=Promise.resolve();return r&&r.length>0&&_.each(r,function(r){n=n.then(function(){var n=null,t=null;return new Promise(function(i,o){var a={};_.each(_.isArray(r)?r:[r],function(e){a[e]=!1}),n=function(e){o(e)},t=function(e){a[e.task]=!0,_.some(_.values(a),function(e){return!e})||i()},e.on("task_stop",t).on("task_err",n),e.start(r)}).then(function(){e.removeListener&&(e.removeListener("task_stop",t),e.removeListener("task_err",n))},function(r){e.removeListener&&(e.removeListener("task_stop",t),e.removeListener("task_err",n)),console.error(r)})})}),n}function files(e,r){var n=[];return r=r||function(e){return!0},_.each(fs_1.readdirSync(e),function(t){var i=e+"/"+t,o=fs_1.lstatSync(i);o.isDirectory()?n=n.concat(files(i,r)):r(i)&&n.push(i)}),n}function generateTask(e,r,n){var t=[];return _.each(_.isArray(e)?e:[e],function(e){if(!(e.oper&&(e.oper&r)<=0))if(e.watch){if(!n.watch)return;console.log("register watch  dynamic task:",chalk.cyan(e.name)),t.push(createWatchTask(e))}else _.isFunction(e.task)?(console.log("register custom dynamic task:",chalk.cyan(e.name)),t.push(createTask(e))):(console.log("register pipes  dynamic task:",chalk.cyan(e.name)),t.push(createPipesTask(e)))}),t}function getCurrentDist(e,r){var n=void 0;switch(r){case Operation.build:n=e.build||e.dist;break;case Operation.test:n=e.test||e.build||e.dist;break;case Operation.e2e:n=e.e2e||e.build||e.dist;break;case Operation.release:n=e.release||e.dist;break;case Operation.deploy:n=e.deploy||e.dist;break;default:n=""}return n}function addTask(e,r){if(!r)return e;if(_.isString(r)||_.isArray(r))e.push(r);else if(r.name){if(_.isNumber(r.order)&&r.order>=0&&r.order<e.length)return e.splice(r.order,0,r.name),e;e.push(r.name)}return e}function createTask(e){return function(r,n){var t=n.subTaskName(e.name);return r.task(t,function(){return e.task(n,e,r)}),_.isNumber(e.order)?{name:t,order:e.order}:t}}function createWatchTask(e){return function(r,n){var t=_.isFunction(e.watch)?e.watch(n):e.watch;_.isFunction(_.last(t))||t.push(function(r){e.watchChanged&&e.watchChanged(r,n)}),t=_.map(t,function(e){return _.isString(e)?n.subTaskName(e):e});var i=n.subTaskName(e.name);return r.task(i,function(){console.log("watch, src:",chalk.cyan.call(chalk,n.option.src)),r.watch(n.option.src,t)}),_.isNumber(e.order)?{name:i,order:e.order}:i}}function createPipesTask(e){return function(r,n){var t=n.subTaskName(e.name);return r.task(t,function(){var t=Promise.resolve(r.src(e.src||n.option.src));if(e.pipes){var i=_.isFunction(e.pipes)?e.pipes(n,e):e.pipes;_.each(i,function(i){t=t.then(function(t){return Promise.resolve(_.isFunction(i)?i(n,e,r):i).then(function(e){return t.pipe(e)})})})}else e.pipe&&(t=t.then(function(r){return e.pipe(r,n,e)}));return t.then(function(t){if(e.output){var i=_.isFunction(e.output)?e.output(n,e):e.output;return Promise.all(_.map(i,function(i){return new Promise(function(o,a){Promise.resolve(_.isFunction(i)?i(t,n,e,r):i).then(function(e){t.pipe(e).once("end",o).once("error",a)})})}))}return new Promise(function(i,o){t.pipe(r.dest(n.getDist(e))).once("end",i).once("error",o)})}),t.catch(function(e){console.log(chalk.red(e))})}),_.isNumber(e.order)?{name:t,order:e.order}:t}}var _=require("lodash"),chalk=require("chalk"),fs_1=require("fs");!function(e){e[e.build=1]="build",e[e.test=2]="test",e[e.e2e=4]="e2e",e[e.release=8]="release",e[e.deploy=16]="deploy"}(exports.Operation||(exports.Operation={}));var Operation=exports.Operation;exports.task=task,exports.bindingConfig=bindingConfig,exports.currentOperation=currentOperation,exports.toSequence=toSequence,exports.runSequence=runSequence,exports.files=files,exports.generateTask=generateTask;
//# sourceMappingURL=sourcemaps/TaskConfig.js.map
