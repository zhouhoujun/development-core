"use strict";function task(e){Object.seal(e),Object.seal(e.prototype)}function bindingConfig(e){return e.fileFilter=e.fileFilter||files,e.runSequence=e.runSequence||runSequence,e.addTask=e.addTask||addTask,e.generateTask=e.generateTask||function(n){return generateTask(n,e.oper,e.env)},e.subTaskName=e.subTaskName||function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return e.option.name?e.option.name+"-"+(n||t):n},e.getDist=e.getDist||function(n){if(n){var t=getCurrentDist(n,e.oper);if(t)return t}return getCurrentDist(e.option,e.oper)},e}function currentOperation(e){var n=void 0;return n=e.deploy?Operation.deploy:e.release?Operation.release:e.e2e?Operation.e2e:e.test?Operation.test:Operation.build}function toSequence(e,n){var t=[],r=e.length;return e=_.orderBy(e,function(e){return e?_.isString(e)?r:_.isArray(e)?r:e.order:r}),_.each(e,function(e){e&&(_.isString(e)?t.push(e):_.isArray(e)?t.push(_.flatten(toSequence(e,n))):e.name&&e.oper&&(e.oper&n)>0&&t.push(e.name))}),t}function runSequence(e,n){var t=Promise.resolve();return n&&n.length>0&&_.each(n,function(n){t=t.then(function(){var t=null,r=null;return new Promise(function(i,a){var o={};_.each(_.isArray(n)?n:[n],function(e){o[e]=!1}),t=function(e){a(e)},r=function(e){o[e.task]=!0,_.some(_.values(o),function(e){return!e})||i()},e.on("task_stop",r).on("task_err",t),e.start(n)}).then(function(){e.removeListener&&(e.removeListener("task_stop",r),e.removeListener("task_err",t))},function(n){e.removeListener&&(e.removeListener("task_stop",r),e.removeListener("task_err",t)),console.error(n)})})}),t}function files(e,n){var t=[];return n=n||function(e){return!0},_.each(fs_1.readdirSync(e),function(r){var i=e+"/"+r,a=fs_1.lstatSync(i);a.isDirectory()?t=t.concat(files(i,n)):n(i)&&t.push(i)}),t}function generateTask(e,n,t){var r=[];return _.each(_.isArray(e)?e:[e],function(e){if(!(e.oper&&(e.oper&n)<=0))if(e.watch){if(!t.watch)return;console.log("register watch  dynamic task:",chalk.cyan(e.name)),r.push(createWatchTask(e))}else _.isFunction(e.task)?(console.log("register custom dynamic task:",chalk.cyan(e.name)),r.push(createTask(e))):(console.log("register pipes  dynamic task:",chalk.cyan(e.name)),r.push(createPipesTask(e)))}),r}function getCurrentDist(e,n){var t=void 0;switch(n){case Operation.build:t=e.build||e.dist;break;case Operation.test:t=e.test||e.build||e.dist;break;case Operation.e2e:t=e.e2e||e.build||e.dist;break;case Operation.release:t=e.release||e.dist;break;case Operation.deploy:t=e.deploy||e.dist;break;default:t=""}return t}function addTask(e,n){if(!n)return e;if(_.isString(n)||_.isArray(n))e.push(n);else if(n.name){if(_.isNumber(n.order)&&n.order>=0&&n.order<e.length)return e.splice(n.order,0,n.name),e;e.push(n.name)}return e}function createTask(e){return function(n,t){var r=t.subTaskName(e.name);return n.task(r,function(){return e.task(t,e,n)}),r}}function createWatchTask(e){return function(n,t){var r=_.isFunction(e.watch)?e.watch(t):e.watch;return _.isFunction(_.last(r))||r.push(function(n){e.watchChanged&&e.watchChanged(n,t)}),r=_.map(r,function(e){return _.isString(e)?t.subTaskName(e):e}),n.task(e.name,function(){console.log("watch, src:",chalk.cyan.call(chalk,t.option.src)),n.watch(t.option.src,r)}),e.name}}function createPipesTask(e){return function(n,t){var r=t.subTaskName(e.name);return n.task(r,function(){var r=Promise.resolve(n.src(e.src||t.option.src));if(e.pipes){var i=_.isFunction(e.pipes)?e.pipes(t,e):e.pipes;_.each(i,function(i){r=r.then(function(r){return Promise.resolve(_.isFunction(i)?i(t,e,n):i).then(function(e){return r.pipe(e)})})})}else e.pipe&&(r=r.then(function(n){return e.pipe(n,t,e)}));return r.then(function(r){if(e.output){var i=_.isFunction(e.output)?e.output(t,e):e.output;return Promise.all(_.map(i,function(i){return new Promise(function(a,o){Promise.resolve(_.isFunction(i)?i(r,t,e,n):i).then(function(e){r.pipe(e).once("end",a).once("error",o)})})}))}return new Promise(function(i,a){r.pipe(n.dest(t.getDist(e))).once("end",i).once("error",a)})}),r.catch(function(e){console.log(chalk.red(e))})}),r}}var _=require("lodash"),chalk=require("chalk"),fs_1=require("fs");!function(e){e[e.build=1]="build",e[e.test=2]="test",e[e.e2e=4]="e2e",e[e.release=8]="release",e[e.deploy=16]="deploy"}(exports.Operation||(exports.Operation={}));var Operation=exports.Operation;exports.task=task,exports.bindingConfig=bindingConfig,exports.currentOperation=currentOperation,exports.toSequence=toSequence,exports.runSequence=runSequence,exports.files=files,exports.generateTask=generateTask;
//# sourceMappingURL=sourcemaps/TaskConfig.js.map
