"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var TaskConfig_1=require("./TaskConfig"),utils_1=require("./utils"),coregulp=require("gulp"),chalk=require("chalk"),_=require("lodash"),PipeTask=function(){function t(t){this.runWay=TaskConfig_1.RunWay.parallel,this.operateFileds=["name","oper","order","nonePipe","noneOutput"],this.info=t||{},this.info.name=this.info.name||this.name}return t.prototype.getInfo=function(){return this.info.name||(this.info.name=this.name),this.info},t.prototype.source=function(t,e,r){var n=t.option;if(n.source)return _.isFunction(n.source)?n.source(t,e,r):n.source;var o=n.loader;return o&&n.source?_.isFunction(o.source)?o.source(t,e,r):o.source:r.src(t.getSrc(this.getInfo()))},t.prototype.pipes=function(t,e,r){var n=t.option,o=null,i=n.loader;if(i&&_.isFunction(i.pipes)&&(o=_.isFunction(i.pipes)?i.pipes(t,n,r):_.filter(i.pipes,function(t){return t})),n.pipes){var u=_.isFunction(n.pipes)?n.pipes(t,n,r):_.filter(n.pipes,function(t){return t});u&&u.length>0&&(o=o?o.concat(u):u)}return o||[]},t.prototype.output=function(t,e,r){var n=t.option,o=null,i=n.loader;if(i&&!_.isString(i)&&!_.isArray(i))if(i.output)o=_.isFunction(i.output)?i.output(t,n,r):_.filter(i.pipes,function(t){return t});else if(null===i.output)return[function(t){return t}];if(n.output){var u=_.isFunction(n.output)?n.output(t,n,r):_.filter(n.output,function(t){return t});u&&u.length>0&&(o=o?o.concat(u):u)}else if(null===n.output)return[function(t){return t}];return o||[function(n){return n.pipe(r.dest(t.getDist(e)))}]},t.prototype.customPipe=function(t,e,r,n){var o,i,u=this,s=e.option,p=s.loader;return s.pipe&&(i=this.getTransformOperate(t),o=this.cpipe2Promise(t,s,e,r,n)),p&&!_.isString(p)&&!_.isArray(p)&&p.pipe&&(i=this.getTransformOperate(t),o=o?o.then(function(t){return u.setTransformOperate(t,i),u.cpipe2Promise(t,p,e,r,n)}):this.cpipe2Promise(t,p,e,r,n)),o?o.then(function(t){return u.setTransformOperate(t,i),t}):t},t.prototype.getOption=function(t){return t.option},t.prototype.match=function(t,e,r,n,o){return void 0===o&&(o=!1),this.matchOperate(t,e,r,o)||n&&this.matchOperate(n,e,r,o)},t.prototype.matchOperate=function(t,e,r,n){return void 0===n&&(n=!1),!!t&&(!(t.name&&!e.endsWith(r.toStr(t.name)))&&(!(t.oper&&(t.oper&r.oper)<=0)&&((!n||t.noneOutput!==!0)&&!(!n&&t.nonePipe===!0))))},t.prototype.cpipe2Promise=function(t,e,r,n,o){return new Promise(function(i,u){var s=e.pipe(t,r,n,o,function(t){t?u(t):i()});s&&Promise.resolve(s).then(i,u)})},t.prototype.getTransformOperate=function(t){return _.pick(t,this.operateFileds)},t.prototype.setTransformOperate=function(t,e){t&&_.each(this.operateFileds,function(r){_.isUndefined(e[r])||(t[r]=e[r])})},t.prototype.pipes2Promise=function(t,e,r,n,o){var i=this,u=e.taskName(r,this.name),s=this.getTransformOperate(t);return this.match(s,u,e)?Promise.all(_.map(o||this.pipes(e,r,n),function(t){return _.isFunction(t)?t(e,r,n):i.match(t,u,e)?Promise.resolve(t.toTransform(e,r,n)).then(function(e){return i.setTransformOperate(e,t),e}):null})).then(function(r){var n=utils_1.sortOrder(r,function(t){return t.order},e,!0);return _.each(n,function(r){i.match(r,u,e,s)&&(t=_.isFunction(r.transformSourcePipe)?r.transformSourcePipe(t):_.isFunction(t.transformPipe)?t.transformPipe(r):t.pipe(r))}),i.setTransformOperate(t,s),t}):Promise.resolve(t)},t.prototype.output2Promise=function(t,e,r,n,o){var i=this,u=e.taskName(r,this.name),s=this.getTransformOperate(t),p=o||this.output(e,r,n);return Promise.all(_.map(p,function(o){return _.isFunction(o)?o(t,e,r,n):i.match(o,u,e,s,!0)?o.toTransform(t,e,r,n):null})).then(function(t){return Promise.all(_.map(t,function(t){return new Promise(function(e,r){t?t.once("end",function(){e(t)}).once("error",r):e()}).then(function(e){return t.removeAllListeners("error"),t.removeAllListeners("end"),e})}))})},t.prototype.working=function(t,e,r,n,o,i){var u=this;return Promise.resolve(t).then(function(t){return u.customPipe(t,e,r,n)}).then(function(t){return u.pipes2Promise(t,e,r,n,o)}).then(function(t){return u.output2Promise(t,e,r,n,i)}).catch(function(t){console.log(chalk.red(t)),process.exit(0)})},t.prototype.execute=function(t,e){var r=this,n=this.getOption(t);return Promise.resolve(this.source(t,n,e)).then(function(o){if(_.isArray(o)){if(r.runWay===TaskConfig_1.RunWay.parallel)return Promise.all(_.map(o,function(o){return r.working(o,t,n,e)}));if(r.runWay===TaskConfig_1.RunWay.sequence){var i;return _.each(o,function(o){i=i?i.then(function(){return r.working(o,t,n,e)}):r.working(o,t,n,e)}),i}return Promise.reject("runWay setting error.")}return r.working(o,t,n,e)})},t.prototype.setup=function(t,e){var r=this;e=e||coregulp;var n=t.taskName(this.getInfo());return console.log("register "+(this.name||"")+" task:",chalk.cyan(n)),e.task(n,function(){return r.execute(t,e)}),this.info.taskName=n,n},t}();exports.PipeTask=PipeTask;
//# sourceMappingURL=sourcemaps/PipeTask.js.map
