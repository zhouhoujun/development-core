"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,r,t){return r&&e(n.prototype,r),t&&e(n,t),n}}(),coregulp=require("gulp"),chalk=require("chalk"),_=require("lodash");!function(e){e[e.sequence=1]="sequence",e[e.parallel=2]="parallel"}(exports.RunWay||(exports.RunWay={}));var RunWay=exports.RunWay,PipeTask=function(){function e(n){_classCallCheck(this,e),this.runWay=RunWay.parallel,this.decorator=n||{}}return _createClass(e,[{key:"pipes",value:function(e,n,r){var t=e.option,o=t.loader;return o&&_.isFunction(o.pipes)?_.isFunction(o.pipes)?o.pipes(e,t,r):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===n.name}):[]}},{key:"output",value:function(e,n,r){var t=e.option,o=t.loader;if(o&&!_.isString(o)&&!_.isArray(o)){if(o.output)return _.isFunction(o.output)?o.output(e,t,r):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===n.name});if(null===o.output)return[function(e){return e}]}return[function(t){return t.pipe(r.dest(e.getDist(n)))}]}},{key:"getOption",value:function(e){return e.option}},{key:"sourceStream",value:function(e,n,r){return r.src(e.getSrc(n,this.decorator))}},{key:"match",value:function(e,n,r){return!!e&&(!(e.name&&!n.endsWith(e.name))&&!(e.oper&&(e.oper&r.oper)<=0))}},{key:"working",value:function(e,n,r,t,o,u){var i=this,a=n.subTaskName(r,this.name);return Promise.resolve(e).then(function(e){return Promise.all(_.map(o||i.pipes(n,r,t),function(e){return _.isFunction(e)?e(n,r,t):i.match(e,a,n)?Promise.resolve(e.toTransform(n,r,t)).then(function(n){return n.order=e.order,n}):null})).then(function(r){var t=r.length;return r=_.orderBy(_.filter(r,function(e){return e}),function(e){return _.isArray(e)?t:_.isNumber(e.order)?e.order:t}),_.each(r,function(r){i.match(r,a,n)&&(e=_.isFunction(r.transformSourcePipe)?r.transformSourcePipe(e):_.isFunction(e.transformPipe)?e.transformPipe(r):e.pipe(r))}),e})}).then(function(e){var o=u||i.output(n,r,t);return Promise.all(_.map(o,function(o){return _.isFunction(o)?o(e,n,r,t):i.match(o,a,n)?o.toTransform(e,n,r,t):null}))}).then(function(e){return Promise.all(_.map(e,function(e){return new Promise(function(n,r){e?e.once("end",function(){n(e)}).once("error",r):n()})}))}).catch(function(e){console.log(chalk.red(e)),process.exit(0)})}},{key:"execute",value:function(e,n){var r=this,t=this.getOption(e);return Promise.resolve(this.sourceStream(e,t,n)).then(function(o){if(!_.isArray(o))return r.working(o,e,t,n);if(r.runWay===RunWay.parallel)return Promise.all(_.map(o,function(o){return r.working(o,e,t,n)}));if(r.runWay!==RunWay.sequence)return Promise.reject("runWay setting error.");var u=function(){var u=void 0;return _.each(o,function(o){u=u?u.then(function(){return r.working(o,e,t,n)}):r.working(o,e,t,n)}),{v:u}}();return"object"===("undefined"==typeof u?"undefined":_typeof(u))?u.v:void 0})}},{key:"setup",value:function(e,n){var r=this;n=n||coregulp;var t=this.getOption(e),o=e.subTaskName(t,this.name);return console.log("register "+this.name+" task:",chalk.cyan(o)),n.task(o,function(){return r.execute(e,n)}),this.decorator.taskName=o,o}}]),e}();exports.PipeTask=PipeTask;
//# sourceMappingURL=sourcemaps/PipeTask.js.map
