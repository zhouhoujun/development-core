"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var sortOrder_1=require("./utils/sortOrder"),coregulp=require("gulp"),chalk=require("chalk"),_=require("lodash"),RunWay_1=require("./RunWay"),PipeTask=function(){function e(e){this.runWay=RunWay_1.RunWay.parallel,this.operateKey="pipe_operate",this.operateFileds=["name","oper","order","nonePipe","noneOutput"],this.info=e||{},this.info.name=this.info.name||this.name}return e.prototype.getInfo=function(){return this.info.name||(this.info.name=this.name),this.info},e.prototype.source=function(e,t,r){var n=e.option;if(n.source)return _.isFunction(n.source)?n.source(e,t,r):n.source;var o=n.loader;return o&&n.source?_.isFunction(o.source)?o.source(e,t,r):o.source:r.src(e.getSrc(this.getInfo()))},e.prototype.pipes=function(e,t,r){var n=e.option,o=null,i=n.loader;if(i&&_.isFunction(i.pipes)&&(o=_.isFunction(i.pipes)?i.pipes(e,n,r):_.filter(i.pipes,function(e){return e})),n.pipes){var u=_.isFunction(n.pipes)?n.pipes(e,n,r):_.filter(n.pipes,function(e){return e});u&&u.length>0&&(o=o?o.concat(u):u)}return o||[]},e.prototype.output=function(e,t,r){var n=e.option,o=null,i=n.loader;if(i&&!_.isString(i)&&!_.isArray(i))if(i.output)o=_.isFunction(i.output)?i.output(e,n,r):_.filter(i.pipes,function(e){return e});else if(null===i.output)return[function(e){return e}];if(n.output){var u=_.isFunction(n.output)?n.output(e,n,r):_.filter(n.output,function(e){return e});u&&u.length>0&&(o=o?o.concat(u):u)}else if(null===n.output)return[function(e){return e}];return o||[function(n){return n.pipe(r.dest(e.getDist(t)))}]},e.prototype.customPipe=function(e,t,r,n){var o,i,u=this,s=t.option,p=s.loader;return s.pipe&&(i=this.getTransformOperate(e),o=this.cpipe2Promise(e,s,t,r,n)),p&&!_.isString(p)&&!_.isArray(p)&&p.pipe&&(i=this.getTransformOperate(e),o=o?o.then(function(e){return u.setTransformOperate(e,i),u.cpipe2Promise(e,p,t,r,n)}):this.cpipe2Promise(e,p,t,r,n)),o?o.then(function(e){return u.setTransformOperate(e,i),e}):e},e.prototype.getOption=function(e){return e.option},e.prototype.match=function(e,t,r,n,o){return void 0===o&&(o=!1),this.matchOperate(e,t,r,o)||n&&this.matchOperate(n,t,r,o)},e.prototype.matchOperate=function(e,t,r,n){return void 0===n&&(n=!1),!!e&&(!(e.name&&!t.endsWith(r.toStr(e.taskName||e.name)))&&(!(e.oper&&(r.to(e.oper)&r.oper)<=0)&&((!n||e.noneOutput!==!0)&&!(!n&&e.nonePipe===!0))))},e.prototype.cpipe2Promise=function(e,t,r,n,o){return new Promise(function(i,u){var s=t.pipe(e,r,n,o,function(e){e?u(e):i()});s&&Promise.resolve(s).then(i,u)})},e.prototype.getTransformOperate=function(e){return e?e[this.operateKey]?e[this.operateKey]:_.pick(e,this.operateFileds):null},e.prototype.setTransformOperate=function(e,t){if(e){var r=e[this.operateKey]=e[this.operateKey]||{};_.each(this.operateFileds,function(e){_.isUndefined(t[e])||(r[e]=t[e])})}},e.prototype.pipes2Promise=function(e,t,r,n,o){var i=this,u=t.taskName(r,this.name),s=this.getTransformOperate(e);return this.match(s,u,t)?(o=o||this.pipes(t,r,n),Promise.all(_.map(o,function(e){return _.isFunction(e)?e(t,r,n):i.match(e,u,t)?(e.pipe=e.pipe||e.toTransform,e.pipe?Promise.resolve(e.pipe(t,r,n)).then(function(t){return i.setTransformOperate(t,e),t}):null):null})).then(function(r){var n=sortOrder_1.sortOrder(r,function(e){return i.getTransformOperate(e).order},t,!0);return _.each(n,function(r){i.match(i.getTransformOperate(r),u,t,s)&&(e=_.isFunction(r.transformSourcePipe)?r.transformSourcePipe(e):_.isFunction(e.transformPipe)?e.transformPipe(r):e.pipe(r))}),i.setTransformOperate(e,s),e})):Promise.resolve(e)},e.prototype.output2Promise=function(e,t,r,n,o){var i=this,u=t.taskName(r,this.name),s=this.getTransformOperate(e);return o=o||this.output(t,r,n),Promise.all(_.map(o,function(o){return _.isFunction(o)?o(e,t,r,n):i.match(i.getTransformOperate(o),u,t,s,!0)?o.toTransform(e,t,r,n):null})).then(function(e){return Promise.all(_.map(e,function(e){return new Promise(function(t,r){e?e.once("end",function(){t(e)}).once("error",r):t()}).then(function(t){return e.removeAllListeners("error"),e.removeAllListeners("end"),t})}))})},e.prototype.working=function(e,t,r,n,o,i){var u=this;return Promise.resolve(e).then(function(e){return u.customPipe(e,t,r,n)}).then(function(e){return u.pipes2Promise(e,t,r,n,o)}).then(function(e){return u.output2Promise(e,t,r,n,i)})},e.prototype.execute=function(e,t){var r=this,n=this.getOption(e);return Promise.resolve(this.source(e,n,t)).then(function(o){if(_.isArray(o)){if(r.runWay===RunWay_1.RunWay.parallel)return Promise.all(_.map(o,function(o){return r.working(o,e,n,t)}));if(r.runWay===RunWay_1.RunWay.sequence){var i;return _.each(o,function(o){i=i?i.then(function(){return r.working(o,e,n,t)}):r.working(o,e,n,t)}),i}return Promise.reject("runWay setting error.")}return r.working(o,e,n,t)})},e.prototype.setup=function(e,t){var r=this;t=t||coregulp;var n=e.taskName(this.getInfo());return console.log("register "+(this.name||"")+" task:",chalk.cyan(n)),t.task(n,function(){return r.execute(e,t)}),this.info.taskName=n,n},e}();exports.PipeTask=PipeTask;
//# sourceMappingURL=sourcemaps/PipeTask.js.map
