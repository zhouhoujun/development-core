"use strict";function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},_createClass=function(){function n(n,e){for(var r=0;r<e.length;r++){var t=e[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}return function(e,r,t){return r&&n(e.prototype,r),t&&n(e,t),e}}(),coregulp=require("gulp"),chalk=require("chalk"),_=require("lodash");!function(n){n[n.sequence=1]="sequence",n[n.parallel=2]="parallel"}(exports.RunWay||(exports.RunWay={}));var RunWay=exports.RunWay,PipeTask=function(){function n(e){_classCallCheck(this,n),this.runWay=RunWay.parallel,this.decorator=e||{}}return _createClass(n,[{key:"pipes",value:function(n,e,r){var t=n.option,o=t.loader;return o&&_.isFunction(o.pipes)?_.isFunction(o.pipes)?o.pipes(n,t,r):_.filter(o.pipes,function(n){return _.isFunction(n)||n.name&&n.name===e.name}):[]}},{key:"output",value:function(n,e,r){var t=n.option,o=t.loader;if(o&&!_.isString(o)&&!_.isArray(o)){if(o.output)return _.isFunction(o.output)?o.output(n,t,r):_.filter(o.pipes,function(n){return _.isFunction(n)||n.name&&n.name===e.name});if(null===o.output)return[function(n){return n}]}return[function(t){return t.pipe(r.dest(n.getDist(e)))}]}},{key:"getOption",value:function(n){return n.option}},{key:"sourceStream",value:function(n,e,r){return r.src(n.getSrc(e,this.decorator))}},{key:"match",value:function(n,e,r){return!!n&&(!(n.name&&!e.endsWith(e))&&!(n.oper&&(n.oper&r.oper)<=0))}},{key:"working",value:function(n,e,r,t){var o=this,u=e.subTaskName(r,this.name);return Promise.resolve(n).then(function(n){return Promise.all(_.map(o.pipes(e,r,t),function(n){return _.isFunction(n)?n(e,r,t):o.match(n,u,e)?Promise.resolve(n.toTransform(e,r,t)).then(function(e){return e.order=n.order,e}):null})).then(function(r){var t=r.length;return r=_.orderBy(_.filter(r,function(n){return n}),function(n){return _.isArray(n)?t:_.isNumber(n.order)?n.order:t}),_.each(r,function(r){o.match(r,u,e)&&(n=_.isFunction(r.transformSourcePipe)?r.transformSourcePipe(n):_.isFunction(n.transformPipe)?n.transformPipe(r):n.pipe(r))}),n})}).then(function(n){var i=o.output(e,r,t);return Promise.all(_.map(i,function(i){return _.isFunction(i)?i(n,e,r,t):o.match(i,u,e)?i.toTransform(n,e,r,t):null}))}).then(function(n){return Promise.all(_.map(n,function(n){return new Promise(function(e,r){n?n.once("end",function(){e(n)}).once("error",r):e()})}))}).catch(function(n){console.log(chalk.red(n)),process.exit(0)})}},{key:"setup",value:function(n,e){var r=this;e=e||coregulp;var t=this.getOption(n),o=n.subTaskName(t,this.name);return console.log("register "+this.name+" task:",chalk.cyan(o)),e.task(o,function(){return Promise.resolve(r.sourceStream(n,t,e)).then(function(o){if(!_.isArray(o))return r.working(o,n,t,e);if(r.runWay===RunWay.parallel)return Promise.all(_.map(o,function(o){return r.working(o,n,t,e)}));if(r.runWay!==RunWay.sequence)return Promise.reject("runWay setting error.");var u=function(){var u=void 0;return _.each(o,function(o){u=u?u.then(function(){return r.working(o,n,t,e)}):r.working(o,n,t,e)}),{v:u}}();return"object"===("undefined"==typeof u?"undefined":_typeof(u))?u.v:void 0})}),this.decorator.taskName=o,o}}]),n}();exports.PipeTask=PipeTask;
//# sourceMappingURL=sourcemaps/PipeTask.js.map
