"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var TaskConfig_1=require("./TaskConfig"),utils_1=require("./utils"),coregulp=require("gulp"),chalk=require("chalk"),_=require("lodash"),PipeTask=function(){function e(e){this.runWay=TaskConfig_1.RunWay.parallel,this.operateFileds=["name","oper","order","nonePipe","noneOutput"],this.info=e||{},this.info.name=this.info.name||this.name}return e.prototype.getInfo=function(){return this.info.name||(this.info.name=this.name),this.info},e.prototype.source=function(e,t,n){var r=e.option;if(r.source)return _.isFunction(r.source)?r.source(e,t,n):r.source;var i=r.loader;return i&&r.source?_.isFunction(i.source)?i.source(e,t,n):i.source:n.src(e.getSrc(this.getInfo()))},e.prototype.pipes=function(e,t,n){var r=e.option,i=null,o=r.loader;if(o&&_.isFunction(o.pipes)&&(i=_.isFunction(o.pipes)?o.pipes(e,r,n):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===t.name})),r.pipes){var u=_.isFunction(r.pipes)?r.pipes(e,r,n):_.filter(r.pipes,function(e){return _.isFunction(e)||e.name&&e.name===t.name});u&&u.length>0&&(i=i?i.concat(u):u)}return i||[]},e.prototype.output=function(e,t,n){var r=e.option,i=null,o=r.loader;if(o&&!_.isString(o)&&!_.isArray(o))if(o.output)i=_.isFunction(o.output)?o.output(e,r,n):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===t.name});else if(null===o.output)return[function(e){return e}];if(r.output){var u=_.isFunction(r.output)?r.output(e,r,n):_.filter(r.output,function(e){return _.isFunction(e)||e.name&&e.name===t.name});u&&u.length>0&&(i=i?i.concat(u):u)}else if(null===r.output)return[function(e){return e}];return i||[function(r){return r.pipe(n.dest(e.getDist(t)))}]},e.prototype.customPipe=function(e,t,n,r){var i,o=this,u=t.option,s=u.loader,p=this.getTransformOperate(e);return u.pipe&&(i=this.cpipe2Promise(e,u,t,n,r)),s&&!_.isString(s)&&!_.isArray(s)&&s.pipe&&(i=i?i.then(function(e){return o.setTransformOperate(e,p),o.cpipe2Promise(e,s,t,n,r)}):this.cpipe2Promise(e,s,t,n,r)),i?i.then(function(e){return o.setTransformOperate(e,p),e}):e},e.prototype.getOption=function(e){return e.option},e.prototype.match=function(e,t,n,r,i){if(void 0===i&&(i=!1),!e)return!1;if(e.name&&!t.endsWith(n.toStr(e.name)))return!1;if(e.oper&&(e.oper&n.oper)<=0)return!1;if(i&&e.noneOutput)return!1;if(!i&&e.nonePipe)return!1;if(r){if(r.name&&!t.endsWith(n.toStr(r.name)))return!1;if(r.oper&&(r.oper&n.oper)<=0)return!1;if(i&&r.noneOutput)return!1;if(!i&&r.nonePipe)return!1}return!0},e.prototype.cpipe2Promise=function(e,t,n,r,i){return new Promise(function(o,u){var s=t.pipe(e,n,r,i,function(e){e?u(e):o()});s&&Promise.resolve(s).then(o,u)})},e.prototype.getTransformOperate=function(e){return _.pick(e,this.operateFileds)},e.prototype.setTransformOperate=function(e,t){e&&_.each(this.operateFileds,function(n){_.isUndefined(t[n])||(e[n]=t[n])})},e.prototype.pipes2Promise=function(e,t,n,r,i){var o=this,u=t.subTaskName(n,this.name),s=this.getTransformOperate(e);return Promise.all(_.map(i||this.pipes(t,n,r),function(e){return _.isFunction(e)?e(t,n,r):o.match(e,u,t,s)?Promise.resolve(e.toTransform(t,n,r)).then(function(t){return t.order=e.order,t}):null})).then(function(n){var r=utils_1.sortOrder(n,function(e){return e.order},t,!0);return _.each(r,function(n){o.match(n,u,t,s)&&(e=_.isFunction(n.transformSourcePipe)?n.transformSourcePipe(e):_.isFunction(e.transformPipe)?e.transformPipe(n):e.pipe(n))}),o.setTransformOperate(e,s),e})},e.prototype.output2Promise=function(e,t,n,r,i){var o=this,u=t.subTaskName(n,this.name),s=this.getTransformOperate(e),p=i||this.output(t,n,r);return Promise.all(_.map(p,function(i){return _.isFunction(i)?i(e,t,n,r):o.match(i,u,t,s,!0)?i.toTransform(e,t,n,r):null})).then(function(e){return Promise.all(_.map(e,function(e){return new Promise(function(t,n){e?e.once("end",function(){t(e)}).once("error",n):t()}).then(function(t){return e.removeAllListeners("error"),e.removeAllListeners("end"),t})}))})},e.prototype.working=function(e,t,n,r,i,o){var u=this;return Promise.resolve(e).then(function(e){return u.customPipe(e,t,n,r)}).then(function(e){return u.pipes2Promise(e,t,n,r,i)}).then(function(e){return u.output2Promise(e,t,n,r,o)}).catch(function(e){console.log(chalk.red(e)),process.exit(0)})},e.prototype.execute=function(e,t){var n=this,r=this.getOption(e);return Promise.resolve(this.source(e,r,t)).then(function(i){if(_.isArray(i)){if(n.runWay===TaskConfig_1.RunWay.parallel)return Promise.all(_.map(i,function(i){return n.working(i,e,r,t)}));if(n.runWay===TaskConfig_1.RunWay.sequence){var o;return _.each(i,function(i){o=o?o.then(function(){return n.working(i,e,r,t)}):n.working(i,e,r,t)}),o}return Promise.reject("runWay setting error.")}return n.working(i,e,r,t)})},e.prototype.setup=function(e,t){var n=this;t=t||coregulp;var r=e.subTaskName(this.getInfo());return console.log("register "+(this.name||"")+" task:",chalk.cyan(r)),t.task(r,function(){return n.execute(e,t)}),this.info.taskName=r,r},e}();exports.PipeTask=PipeTask;
//# sourceMappingURL=sourcemaps/PipeTask.js.map
