"use strict";var TaskConfig_1=require("./TaskConfig"),utils_1=require("./utils"),coregulp=require("gulp"),chalk=require("chalk"),_=require("lodash"),PipeTask=function(){function e(e){this.runWay=TaskConfig_1.RunWay.parallel,this.operateFileds=["name","oper","order","nonePipe","noneOutput"],this.info=e||{},this.info.name=this.info.name||this.name}return e.prototype.getInfo=function(){return this.info.name||(this.info.name=this.name),this.info},e.prototype.source=function(e,n,t){var r=e.option;if(r.source)return _.isFunction(r.source)?r.source(e,n,t):r.source;var i=r.loader;return i&&r.source?_.isFunction(i.source)?i.source(e,n,t):i.source:t.src(e.getSrc(this.getInfo()))},e.prototype.pipes=function(e,n,t){var r=e.option,i=null,o=r.loader;if(o&&_.isFunction(o.pipes)&&(i=_.isFunction(o.pipes)?o.pipes(e,r,t):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===n.name})),r.pipes){var u=_.isFunction(r.pipes)?r.pipes(e,r,t):_.filter(r.pipes,function(e){return _.isFunction(e)||e.name&&e.name===n.name});u&&u.length>0&&(i=i?i.concat(u):u)}return i||[]},e.prototype.output=function(e,n,t){var r=e.option,i=null,o=r.loader;if(o&&!_.isString(o)&&!_.isArray(o))if(o.output)i=_.isFunction(o.output)?o.output(e,r,t):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===n.name});else if(null===o.output)return[function(e){return e}];if(r.output){var u=_.isFunction(r.output)?r.output(e,r,t):_.filter(r.output,function(e){return _.isFunction(e)||e.name&&e.name===n.name});u&&u.length>0&&(i=i?i.concat(u):u)}else if(null===r.output)return[function(e){return e}];return i||[function(r){return r.pipe(t.dest(e.getDist(n)))}]},e.prototype.customPipe=function(e,n,t,r){var i,o=this,u=n.option,s=u.loader,p=this.getTransformOperate(e);return u.pipe&&(i=this.cpipe2Promise(e,u,n,t,r)),s&&!_.isString(s)&&!_.isArray(s)&&s.pipe&&(i=i?i.then(function(e){return o.setTransformOperate(e,p),o.cpipe2Promise(e,s,n,t,r)}):this.cpipe2Promise(e,s,n,t,r)),i?i.then(function(e){return o.setTransformOperate(e,p),e}):e},e.prototype.getOption=function(e){return e.option},e.prototype.match=function(e,n,t,r,i){if(void 0===i&&(i=!1),!e)return!1;if(e.name&&!n.endsWith(t.toStr(e.name)))return!1;if(e.oper&&(e.oper&t.oper)<=0)return!1;if(i&&e.noneOutput)return!1;if(!i&&e.nonePipe)return!1;if(r){if(r.name&&!n.endsWith(t.toStr(r.name)))return!1;if(r.oper&&(r.oper&t.oper)<=0)return!1;if(i&&r.noneOutput)return!1;if(!i&&r.nonePipe)return!1}return!0},e.prototype.cpipe2Promise=function(e,n,t,r,i){return new Promise(function(o,u){var s=n.pipe(e,t,r,i,function(e){e?u(e):o()});s&&Promise.resolve(s).then(o,u)})},e.prototype.getTransformOperate=function(e){return _.pick(e,this.operateFileds)},e.prototype.setTransformOperate=function(e,n){e&&_.each(this.operateFileds,function(t){_.isUndefined(n[t])||(e[t]=n[t])})},e.prototype.pipes2Promise=function(e,n,t,r,i){var o=this,u=n.subTaskName(t,this.name),s=this.getTransformOperate(e);return Promise.all(_.map(i||this.pipes(n,t,r),function(e){return _.isFunction(e)?e(n,t,r):o.match(e,u,n,s)?Promise.resolve(e.toTransform(n,t,r)).then(function(n){return n.order=e.order,n}):null})).then(function(t){var r=utils_1.sortOrder(t,function(e){return e.order},n,!0);return _.each(r,function(t){o.match(t,u,n,s)&&(e=_.isFunction(t.transformSourcePipe)?t.transformSourcePipe(e):_.isFunction(e.transformPipe)?e.transformPipe(t):e.pipe(t))}),o.setTransformOperate(e,s),e})},e.prototype.output2Promise=function(e,n,t,r,i){var o=this,u=n.subTaskName(t,this.name),s=this.getTransformOperate(e),p=i||this.output(n,t,r);return Promise.all(_.map(p,function(i){return _.isFunction(i)?i(e,n,t,r):o.match(i,u,n,s,!0)?i.toTransform(e,n,t,r):null})).then(function(e){return Promise.all(_.map(e,function(e){return new Promise(function(n,t){e?e.once("end",function(){n(e)}).once("error",t):n()}).then(function(n){return e.removeAllListeners("error"),e.removeAllListeners("end"),n})}))})},e.prototype.working=function(e,n,t,r,i,o){var u=this;return Promise.resolve(e).then(function(e){return u.customPipe(e,n,t,r)}).then(function(e){return u.pipes2Promise(e,n,t,r,i)}).then(function(e){return u.output2Promise(e,n,t,r,o)}).catch(function(e){console.log(chalk.red(e)),process.exit(0)})},e.prototype.execute=function(e,n){var t=this,r=this.getOption(e);return Promise.resolve(this.source(e,r,n)).then(function(i){if(_.isArray(i)){if(t.runWay===TaskConfig_1.RunWay.parallel)return Promise.all(_.map(i,function(i){return t.working(i,e,r,n)}));if(t.runWay===TaskConfig_1.RunWay.sequence){var o;return _.each(i,function(i){o=o?o.then(function(){return t.working(i,e,r,n)}):t.working(i,e,r,n)}),o}return Promise.reject("runWay setting error.")}return t.working(i,e,r,n)})},e.prototype.setup=function(e,n){var t=this;n=n||coregulp;var r=e.subTaskName(this.getInfo());return console.log("register "+(this.name||"")+" task:",chalk.cyan(r)),n.task(r,function(){return t.execute(e,n)}),this.info.taskName=r,r},e}();exports.PipeTask=PipeTask;
//# sourceMappingURL=sourcemaps/PipeTask.js.map
