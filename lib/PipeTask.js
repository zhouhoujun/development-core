"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),utils_1=require("./utils"),coregulp=require("gulp"),chalk=require("chalk"),_=require("lodash");!function(e){e[e.sequence=1]="sequence",e[e.parallel=2]="parallel"}(exports.RunWay||(exports.RunWay={}));var RunWay=exports.RunWay,PipeTask=function(){function e(n){_classCallCheck(this,e),this.runWay=RunWay.parallel,this.decorator=n||{}}return _createClass(e,[{key:"source",value:function(e,n,t){var r=e.option,i=null;if(r.source)return _.isFunction(r.source)?r.source(e,n,t):r.source;var o=r.loader;return o&&_.isFunction(o.pipes)&&(i=_.isFunction(o.pipes)?o.pipes(e,r,t):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===n.name})),t.src(e.getSrc(this.decorator))}},{key:"pipes",value:function e(n,t,r){var i=n.option,e=null,o=i.loader;if(o&&_.isFunction(o.pipes)&&(e=_.isFunction(o.pipes)?o.pipes(n,i,r):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===t.name})),i.pipes){var u=_.isFunction(i.pipes)?i.pipes(n,i,r):_.filter(i.pipes,function(e){return _.isFunction(e)||e.name&&e.name===t.name});u&&u.length>0&&(e=e?e.concat(u):u)}return e||[]}},{key:"output",value:function(e,n,t){var r=e.option,i=null,o=r.loader;if(o&&!_.isString(o)&&!_.isArray(o))if(o.output)i=_.isFunction(o.output)?o.output(e,r,t):_.filter(o.pipes,function(e){return _.isFunction(e)||e.name&&e.name===n.name});else if(null===o.output)return[function(e){return e}];if(r.output){var u=_.isFunction(r.output)?r.output(e,r,t):_.filter(r.output,function(e){return _.isFunction(e)||e.name&&e.name===n.name});u&&u.length>0&&(i=i?i.concat(u):u)}else if(null===r.output)return[function(e){return e}];return i||[function(r){return r.pipe(t.dest(e.getDist(n)))}]}},{key:"getOption",value:function(e){return e.option}},{key:"match",value:function(e,n,t){return!!e&&(!(e.name&&!n.endsWith(utils_1.taskStringVal(e.name,e.oper)))&&!(e.oper&&(e.oper&t.oper)<=0))}},{key:"cpipe2Promise",value:function(e,n,t,r,i){return new Promise(function(o,u){var s=n.pipe(e,t,r,i,function(e){e?u(e):o()});s&&Promise.resolve(s).then(o,u)})}},{key:"pipes2Promise",value:function(e,n,t,r,i){var o=this,u=n.subTaskName(t,this.name);return Promise.all(_.map(i||this.pipes(n,t,r),function(e){return _.isFunction(e)?e(n,t,r):o.match(e,u,n)?Promise.resolve(e.toTransform(n,t,r)).then(function(n){return n.order=e.order,n}):null})).then(function(t){var r=t.length;return t=_.orderBy(_.filter(t,function(e){return e}),function(e){return _.isArray(e)?r:_.isNumber(e.order)?e.order:r}),_.each(t,function(t){o.match(t,u,n)&&(e=_.isFunction(t.transformSourcePipe)?t.transformSourcePipe(e):_.isFunction(e.transformPipe)?e.transformPipe(t):e.pipe(t))}),e})}},{key:"output2Promise",value:function(e,n,t,r,i){var o=this,u=n.subTaskName(t,this.name),s=i||this.output(n,t,r);return Promise.all(_.map(s,function(i){return _.isFunction(i)?i(e,n,t,r):o.match(i,u,n)?i.toTransform(e,n,t,r):null})).then(function(e){return Promise.all(_.map(e,function(e){return new Promise(function(n,t){e?e.once("end",function(){n(e)}).once("error",t):n()})}))})}},{key:"customPipe",value:function(e,n,t,r){var i=this,o=n.option,u=o.loader,s=void 0;return o.pipe&&(s=this.cpipe2Promise(e,o,n,t,r)),u&&!_.isString(u)&&!_.isArray(u)&&u.pipe&&(s=s?s.then(function(e){return i.cpipe2Promise(e,u,n,t,r)}):this.cpipe2Promise(e,u,n,t,r)),s||e}},{key:"working",value:function(e,n,t,r,i,o){var u=this;return Promise.resolve(e).then(function(e){return u.customPipe(e,n,t,r)}).then(function(e){return u.pipes2Promise(e,n,t,r,i)}).then(function(e){return u.output2Promise(e,n,t,r,o)}).catch(function(e){console.log(chalk.red(e)),process.exit(0)})}},{key:"execute",value:function(e,n){var t=this,r=this.getOption(e);return Promise.resolve(this.source(e,r,n)).then(function(i){if(!_.isArray(i))return t.working(i,e,r,n);if(t.runWay===RunWay.parallel)return Promise.all(_.map(i,function(i){return t.working(i,e,r,n)}));if(t.runWay!==RunWay.sequence)return Promise.reject("runWay setting error.");var o=function(){var o=void 0;return _.each(i,function(i){o=o?o.then(function(){return t.working(i,e,r,n)}):t.working(i,e,r,n)}),{v:o}}();return"object"===("undefined"==typeof o?"undefined":_typeof(o))?o.v:void 0})}},{key:"setup",value:function(e,n){var t=this;n=n||coregulp;var r=this.getOption(e),i=e.subTaskName(r,this.name);return console.log("register "+(this.name||"")+" task:",chalk.cyan(i)),n.task(i,function(){return t.execute(e,n)}),this.decorator.taskName=i,i}}]),e}();exports.PipeTask=PipeTask;
//# sourceMappingURL=sourcemaps/PipeTask.js.map
