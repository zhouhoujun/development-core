"use strict";function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},_createClass=function(){function n(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),utils_1=require("./utils"),coregulp=require("gulp"),chalk=require("chalk"),_=require("lodash");!function(n){n[n.sequence=1]="sequence",n[n.parallel=2]="parallel"}(exports.RunWay||(exports.RunWay={}));var RunWay=exports.RunWay,PipeTask=function(){function n(e){_classCallCheck(this,n),this.runWay=RunWay.parallel,this.info=e||{},this.info.name=this.info.name||this.name}return _createClass(n,[{key:"getInfo",value:function(){return this.info.name||(this.info.name=this.name),this.info}},{key:"source",value:function(n,e,t){var r=n.option,i=null;if(r.source)return _.isFunction(r.source)?r.source(n,e,t):r.source;var o=r.loader;return o&&_.isFunction(o.pipes)&&(i=_.isFunction(o.pipes)?o.pipes(n,r,t):_.filter(o.pipes,function(n){return _.isFunction(n)||n.name&&n.name===e.name})),t.src(n.getSrc(this.getInfo()))}},{key:"pipes",value:function n(e,t,r){var i=e.option,n=null,o=i.loader;if(o&&_.isFunction(o.pipes)&&(n=_.isFunction(o.pipes)?o.pipes(e,i,r):_.filter(o.pipes,function(n){return _.isFunction(n)||n.name&&n.name===t.name})),i.pipes){var u=_.isFunction(i.pipes)?i.pipes(e,i,r):_.filter(i.pipes,function(n){return _.isFunction(n)||n.name&&n.name===t.name});u&&u.length>0&&(n=n?n.concat(u):u)}return n||[]}},{key:"output",value:function(n,e,t){var r=n.option,i=null,o=r.loader;if(o&&!_.isString(o)&&!_.isArray(o))if(o.output)i=_.isFunction(o.output)?o.output(n,r,t):_.filter(o.pipes,function(n){return _.isFunction(n)||n.name&&n.name===e.name});else if(null===o.output)return[function(n){return n}];if(r.output){var u=_.isFunction(r.output)?r.output(n,r,t):_.filter(r.output,function(n){return _.isFunction(n)||n.name&&n.name===e.name});u&&u.length>0&&(i=i?i.concat(u):u)}else if(null===r.output)return[function(n){return n}];return i||[function(r){return r.pipe(t.dest(n.getDist(e)))}]}},{key:"getOption",value:function(n){return n.option}},{key:"match",value:function(n,e,t){return!!n&&(!(n.name&&!e.endsWith(utils_1.taskStringVal(n.name,t)))&&!(n.oper&&(n.oper&t.oper)<=0))}},{key:"cpipe2Promise",value:function(n,e,t,r,i){return new Promise(function(o,u){var s=e.pipe(n,t,r,i,function(n){n?u(n):o()});s&&Promise.resolve(s).then(o,u)})}},{key:"pipes2Promise",value:function(n,e,t,r,i){var o=this,u=e.subTaskName(t,this.name);return Promise.all(_.map(i||this.pipes(e,t,r),function(n){return _.isFunction(n)?n(e,t,r):o.match(n,u,e)?Promise.resolve(n.toTransform(e,t,r)).then(function(e){return e.order=n.order,e}):null})).then(function(t){var r=t.length;return t=_.orderBy(_.filter(t,function(n){return n}),function(n){return _.isArray(n)?r:_.isNumber(n.order)?n.order:_.isFunction(n.order)?n.order(r):r}),_.each(t,function(t){o.match(t,u,e)&&(n=_.isFunction(t.transformSourcePipe)?t.transformSourcePipe(n):_.isFunction(n.transformPipe)?n.transformPipe(t):n.pipe(t))}),n})}},{key:"output2Promise",value:function(n,e,t,r,i){var o=this,u=e.subTaskName(t,this.name),s=i||this.output(e,t,r);return Promise.all(_.map(s,function(i){return _.isFunction(i)?i(n,e,t,r):o.match(i,u,e)?i.toTransform(n,e,t,r):null})).then(function(n){return Promise.all(_.map(n,function(n){return new Promise(function(e,t){n?n.once("end",function(){e(n)}).once("error",t):e()})}))})}},{key:"customPipe",value:function(n,e,t,r){var i=this,o=e.option,u=o.loader,s=void 0;return o.pipe&&(s=this.cpipe2Promise(n,o,e,t,r)),u&&!_.isString(u)&&!_.isArray(u)&&u.pipe&&(s=s?s.then(function(n){return i.cpipe2Promise(n,u,e,t,r)}):this.cpipe2Promise(n,u,e,t,r)),s||n}},{key:"working",value:function(n,e,t,r,i,o){var u=this;return Promise.resolve(n).then(function(n){return u.customPipe(n,e,t,r)}).then(function(n){return u.pipes2Promise(n,e,t,r,i)}).then(function(n){return u.output2Promise(n,e,t,r,o)}).catch(function(n){console.log(chalk.red(n)),process.exit(0)})}},{key:"execute",value:function(n,e){var t=this,r=this.getOption(n);return Promise.resolve(this.source(n,r,e)).then(function(i){if(!_.isArray(i))return t.working(i,n,r,e);if(t.runWay===RunWay.parallel)return Promise.all(_.map(i,function(i){return t.working(i,n,r,e)}));if(t.runWay!==RunWay.sequence)return Promise.reject("runWay setting error.");var o=function(){var o=void 0;return _.each(i,function(i){o=o?o.then(function(){return t.working(i,n,r,e)}):t.working(i,n,r,e)}),{v:o}}();return"object"===("undefined"==typeof o?"undefined":_typeof(o))?o.v:void 0})}},{key:"setup",value:function(n,e){var t=this;e=e||coregulp;var r=n.subTaskName(this.getInfo());return console.log("register "+(this.name||"")+" task:",chalk.cyan(r)),e.task(r,function(){return t.execute(n,e)}),this.info.taskName=r,r}}]),n}();exports.PipeTask=PipeTask;
//# sourceMappingURL=sourcemaps/PipeTask.js.map
