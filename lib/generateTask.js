"use strict";function generateTask(t,e,n){var r=[];return _.each(_.isArray(e)?e:[e],function(e){e.oper=e.oper?t.to(e.oper):TaskConfig_1.Operation.default,e.watchTasks&&(e.oper=e.oper|TaskConfig_1.Operation.watch),utils_1.matchCompare(t,e,n)&&(!e.watch||e.oper&TaskConfig_1.Operation.watch||(e.oper=e.oper|TaskConfig_1.Operation.autoWatch),r.push(createTask(t,e)))}),r}function createTask(t,e){var n;return n=t.to(e.oper)&TaskConfig_1.Operation.watch?createWatchTask(e):e.shell?new ShellTask(e,e.shell):e.execFiles?new ExecFileTask(e,e.execFiles):_.isFunction(e.task)?createCustomTask(e):createPipesTask(e)}function createCustomTask(t){var e=function(e,n,r){var o=e.taskName(n);return console.log("register custom dynamic task:",chalk.cyan(o)),r.task(o,function(){return t.task(e,t,r)}),o};return new DynamicTask({name:t.name,order:t.order,oper:t.oper,group:t.group,assert:t},e)}function createWatchTask(t){var e=function(e,n,r){var o,i=_.isFunction(t.watchTasks)?t.watchTasks(e,t):t.watchTasks;o=_.isFunction(_.last(i))?i.pop():function(n){t.watchChanged&&t.watchChanged(n,e)},i=_.map(i,function(t){return _.isString(t)?e.taskName(t):t});var s=e.taskName(n);return console.log("register watch  dynamic task:",chalk.cyan(s)),r.task(s,function(){var t=e.getSrc(n);console.log("watch, src:",chalk.cyan.call(chalk,t)),watch(t,function(){taskSequence_1.runSequence(r,i).then(function(){o&&o()})})}),s};return new DynamicTask({name:t.name,order:t.order,oper:t.oper,group:t.group,assert:t},e)}function createPipesTask(t){return new DynamicPipeTask(t)}var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),coregulp=require("gulp"),chalk=require("chalk"),TaskConfig_1=require("./TaskConfig"),utils_1=require("./utils"),PipeTask_1=require("./PipeTask"),taskSequence_1=require("./taskSequence"),watch=require("gulp-watch"),ShellTask=function(){function t(t,e){this.info=t,this.cmd=e}return t.prototype.getInfo=function(){return this.info},t.prototype.setup=function(t,e){var n=this;e=e||coregulp;var r=t.option,o=t.taskName(this.getInfo());return console.log("register shell task:",chalk.cyan(o)),e.task(o,function(){var e=t.to(n.cmd);return Promise.resolve(e).then(function(e){if(_.isString(e))return t.execShell(e,r.execOptions);if(_.isArray(e)){if(r.shellRunWay===TaskConfig_1.RunWay.sequence){var n=Promise.resolve();return _.each(e,function(e){n=n.then(function(){return t.execShell(e,r.execOptions)})}),n}return Promise.all(_.map(e,function(e){return t.execShell(e,r.execOptions)}))}return Promise.reject("shell task config error")})}),this.info.taskName=o,o},t}(),ExecFileTask=function(){function t(t,e){this.info=t,this.files=e}return t.prototype.getInfo=function(){return this.info},t.prototype.setup=function(t,e){var n=this;e=e||coregulp;var r=t.option,o=t.taskName(this.getInfo());return console.log("register exec file task:",chalk.cyan(o)),e.task(o,function(){var e=t.to(n.files);return Promise.resolve(e).then(function(e){if(_.isString(e))return t.execFile(e,r.args,r.execFileOptions);if(_.isArray(e)){if(r.fileRunWay===TaskConfig_1.RunWay.sequence){var n=Promise.resolve();return _.each(e,function(e){n=n.then(function(){return t.execFile(e,r.args,r.execFileOptions)})}),n}return Promise.all(_.map(e,function(e){return t.execFile(e,r.args,r.execFileOptions)}))}return Promise.reject("exec file task config error")})}),this.info.taskName=o,o},t}(),DynamicTask=function(){function t(t,e){this.info=t,this.factory=e}return t.prototype.getInfo=function(){return this.info},t.prototype.setup=function(t,e){var n=this.factory(t,this.getInfo(),e||coregulp);return n&&(this.info.taskName=n),n},t}(),DynamicPipeTask=function(t){function e(e,n){var r=t.call(this,n||e)||this;return r.dt=e,r.info.assert=e,r}return __extends(e,t),e.prototype.getOption=function(t){return this.name=this.name||t.toStr(this.dt.name),this.dt||t.option},e.prototype.customPipe=function(e,n,r,o){var i=this;return this.dt.pipe?Promise.resolve(t.prototype.customPipe.call(this,e,n,r,o)).then(function(t){return i.cpipe2Promise(t,i.dt,n,r,o)}):t.prototype.customPipe.call(this,e,n,r,o)},e.prototype.pipes=function(e,n,r){var o=_.isFunction(this.dt.pipes)?this.dt.pipes(e,n,r):this.dt.pipes;return o=o||[],o.concat(t.prototype.pipes.call(this,e,n,r))},e.prototype.output=function(e,n,r){if(null===this.dt.output)return[function(t){return t}];var o=_.isFunction(this.dt.output)?this.dt.output(e,n,r):this.dt.output;return o=o||[],o.concat(t.prototype.output.call(this,e,n,r))},e}(PipeTask_1.PipeTask);exports.generateTask=generateTask;
//# sourceMappingURL=sourcemaps/generateTask.js.map
