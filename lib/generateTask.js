"use strict";function generateTask(t,e,r){var n=[];return _.each(_.isArray(e)?e:[e],function(e){e.oper=e.oper?t.to(e.oper):TaskConfig_1.Operation.default,e.watchTasks&&(e.oper=e.oper|TaskConfig_1.Operation.watch),utils_1.matchCompare(t,e,r)&&(!e.watch||e.oper&TaskConfig_1.Operation.watch||(e.oper=e.oper|TaskConfig_1.Operation.autoWatch),n.push(createTask(t,e)))}),n}function createTask(t,e){var r;return r=t.to(e.oper)&TaskConfig_1.Operation.watch?createWatchTask(e):e.shell?new ShellTask(e,e.shell):e.execFiles?new ExecFileTask(e,e.execFiles):_.isFunction(e.task)?createCustomTask(e):createPipesTask(e)}function createCustomTask(t){var e=function(e,r,n){var o=e.taskName(r);return console.log("register custom dynamic task:",chalk.cyan(o)),n.task(o,function(){return t.task(e,t,n)}),o};return new DynamicTask({name:t.name,order:t.order,oper:t.oper,group:t.group,assert:t},e)}function createWatchTask(t){var e=function(e,r,n){var o,i=_.isFunction(t.watchTasks)?t.watchTasks(e,t):t.watchTasks;o=_.isFunction(_.last(i))?i.pop():function(r){t.watchChanged&&t.watchChanged(r,e)},i=_.map(i,function(t){return _.isString(t)?e.taskName(t):t});var a=e.taskName(r);return console.log("register watch  dynamic task:",chalk.cyan(a)),n.task(a,function(){var t=e.getSrc(r);console.log("watch, src:",chalk.cyan.call(chalk,t)),watch(t,function(){taskSequence_1.runSequence(n,i).then(function(){o&&o()})})}),a};return new DynamicTask({name:t.name,order:t.order,oper:t.oper,group:t.group,assert:t},e)}function createPipesTask(t){return new DynamicPipeTask(t)}var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),coregulp=require("gulp"),chalk=require("chalk"),TaskConfig_1=require("./TaskConfig"),utils_1=require("./utils"),PipeTask_1=require("./PipeTask"),taskSequence_1=require("./taskSequence"),watch=require("gulp-watch"),ShellTask=function(){function t(t,e){this.info=t,this.cmd=e}return t.prototype.getInfo=function(){return this.info},t.prototype.setup=function(t,e){var r=this;e=e||coregulp;var n=t.option,o=t.taskName(this.getInfo());return console.log("register shell task:",chalk.cyan(o)),e.task(o,function(){var e=t.to(r.cmd);return Promise.resolve(e).then(function(e){if(_.isString(e))return t.execShell(e,n.execOptions,n.allowError!==!1);if(_.isArray(e)){if(n.shellRunWay===TaskConfig_1.RunWay.sequence){var r=Promise.resolve();return _.each(e,function(e){r=r.then(function(){return t.execShell(e,n.execOptions)})}),r}return Promise.all(_.map(e,function(e){return t.execShell(e,n.execOptions,n.allowError!==!1)}))}return Promise.reject("shell task config error")})}),this.info.taskName=o,o},t}(),ExecFileTask=function(){function t(t,e){this.info=t,this.files=e}return t.prototype.getInfo=function(){return this.info},t.prototype.setup=function(t,e){var r=this;e=e||coregulp;var n=t.option,o=t.taskName(this.getInfo());return console.log("register exec file task:",chalk.cyan(o)),e.task(o,function(){var e=t.to(r.files);return Promise.resolve(e).then(function(e){if(_.isString(e))return t.execFile(e,n.args,n.execFileOptions,n.allowError!==!1);if(_.isArray(e)){if(n.fileRunWay===TaskConfig_1.RunWay.sequence){var r=Promise.resolve();return _.each(e,function(e){r=r.then(function(){return t.execFile(e,n.args,n.execFileOptions,n.allowError!==!1)})}),r}return Promise.all(_.map(e,function(e){return t.execFile(e,n.args,n.execFileOptions,n.allowError!==!1)}))}return Promise.reject("exec file task config error")})}),this.info.taskName=o,o},t}(),DynamicTask=function(){function t(t,e){this.info=t,this.factory=e}return t.prototype.getInfo=function(){return this.info},t.prototype.setup=function(t,e){var r=this.factory(t,this.getInfo(),e||coregulp);return r&&(this.info.taskName=r),r},t}(),DynamicPipeTask=function(t){function e(e,r){var n=t.call(this,r||e)||this;return n.dt=e,n.info.assert=e,n}return __extends(e,t),e.prototype.getOption=function(t){return this.name=this.name||t.toStr(this.dt.name),this.dt||t.option},e.prototype.customPipe=function(e,r,n,o){var i=this;return this.dt.pipe?Promise.resolve(t.prototype.customPipe.call(this,e,r,n,o)).then(function(t){return i.cpipe2Promise(t,i.dt,r,n,o)}):t.prototype.customPipe.call(this,e,r,n,o)},e.prototype.pipes=function(e,r,n){var o=_.isFunction(this.dt.pipes)?this.dt.pipes(e,r,n):this.dt.pipes;return o=o||[],o.concat(t.prototype.pipes.call(this,e,r,n))},e.prototype.output=function(e,r,n){if(null===this.dt.output)return[function(t){return t}];var o=_.isFunction(this.dt.output)?this.dt.output(e,r,n):this.dt.output;return o=o||[],o.concat(t.prototype.output.call(this,e,r,n))},e}(PipeTask_1.PipeTask);exports.generateTask=generateTask;
//# sourceMappingURL=sourcemaps/generateTask.js.map
