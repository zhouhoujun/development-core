"use strict";function generateTask(t,e,r,n){var o=[];return _.each(_.isArray(e)?e:[e],function(e){e.oper=e.oper?t.to(e.oper):TaskConfig_1.Operation.default,e.watchTasks&&(e.oper=e.oper|TaskConfig_1.Operation.watch),utils_1.matchCompare(t,e,r)&&(!e.watch||e.oper&TaskConfig_1.Operation.watch||(e.oper=e.oper|TaskConfig_1.Operation.autoWatch),o.push(createTask(t,e,n)))}),o}function createTask(t,e,r){var n;return n=t.to(e.oper)&TaskConfig_1.Operation.watch?r?createPipesTask(e):createWatchTask(e):e.shell?new ShellTask(e,e.shell):e.execFiles?new ExecFileTask(e,e.execFiles):_.isFunction(e.task)?createCustomTask(e):createPipesTask(e)}function createCustomTask(t){return new DynamicTask({name:t.name,order:t.order,oper:t.oper,group:t.group,assert:t},t)}function createWatchTask(t){return new DynamicWatchTask({name:t.name,order:t.order,oper:t.oper,group:t.group,assert:t},t)}function createPipesTask(t){return new DynamicPipeTask(t)}var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),coregulp=require("gulp"),chalk=require("chalk"),TaskConfig_1=require("./TaskConfig"),utils_1=require("./utils"),PipeTask_1=require("./PipeTask"),taskSequence_1=require("./taskSequence"),watch=require("gulp-watch"),ShellTask=function(){function t(t,e){this.info=t,this.cmd=e}return t.prototype.getInfo=function(){return this.info},t.prototype.execute=function(t,e){var r=t.option,n=t.to(this.cmd);return Promise.resolve(n).then(function(e){if(_.isString(e))return t.execShell(e,r.execOptions,r.allowError!==!1);if(_.isArray(e)){if(r.shellRunWay===TaskConfig_1.RunWay.sequence){var n=Promise.resolve();return _.each(e,function(e){n=n.then(function(){return t.execShell(e,r.execOptions)})}),n}return Promise.all(_.map(e,function(e){return t.execShell(e,r.execOptions,r.allowError!==!1)}))}return Promise.reject("shell task config error")})},t.prototype.setup=function(t,e){var r=this;e=e||coregulp;var n=t.taskName(this.getInfo());return console.log("register shell task:",chalk.cyan(n)),e.task(n,function(){return r.execute(t,e)}),this.info.taskName=n,n},t}(),ExecFileTask=function(){function t(t,e){this.info=t,this.files=e}return t.prototype.getInfo=function(){return this.info},t.prototype.execute=function(t,e){var r=t.option,n=t.to(this.files);return Promise.resolve(n).then(function(e){if(_.isString(e))return t.execFile(e,r.args,r.execFileOptions,r.allowError!==!1);if(_.isArray(e)){if(r.fileRunWay===TaskConfig_1.RunWay.sequence){var n=Promise.resolve();return _.each(e,function(e){n=n.then(function(){return t.execFile(e,r.args,r.execFileOptions,r.allowError!==!1)})}),n}return Promise.all(_.map(e,function(e){return t.execFile(e,r.args,r.execFileOptions,r.allowError!==!1)}))}return Promise.reject("exec file task config error")})},t.prototype.setup=function(t,e){var r=this;e=e||coregulp;var n=t.taskName(this.getInfo());return console.log("register exec file task:",chalk.cyan(n)),e.task(n,function(){return r.execute(t,e)}),this.info.taskName=n,n},t}(),DynamicTask=function(){function t(t,e){this.info=t,this.dt=e}return t.prototype.getInfo=function(){return this.info},t.prototype.execute=function(t,e){var r=this.dt.task(t,this.dt,e);return r&&r.then?r:Promise.resolve(r)},t.prototype.setup=function(t,e){var r=this,n=t.taskName(this.getInfo());return console.log("register custom dynamic task:",chalk.cyan(n)),e.task(n,function(){return r.execute(t,e)}),this.info.taskName=n,n},t}(),DynamicWatchTask=function(){function t(t,e){this.info=t,this.dt=e}return t.prototype.getInfo=function(){return this.info},t.prototype.execute=function(t,e){return Promise.resolve()},t.prototype.setup=function(t,e){var r,n=this.dt,o=_.isFunction(n.watchTasks)?n.watchTasks(t,n):n.watchTasks;r=_.isFunction(_.last(o))?o.pop():function(e){n.watchChanged&&n.watchChanged(e,t)},o=_.map(o,function(e){return _.isString(e)?t.taskName(e):e});var i=this.getInfo(),s=t.taskName(i);return console.log("register watch  dynamic task:",chalk.cyan(s)),e.task(s,function(){var n=t.getSrc(i);console.log("watch, src:",chalk.cyan.call(chalk,n)),watch(n,function(){taskSequence_1.runSequence(e,o).then(function(){r&&r()})})}),s},t}(),DynamicPipeTask=function(t){function e(e,r){var n=t.call(this,r||e)||this;return n.dt=e,n.info.assert=e,n}return __extends(e,t),e.prototype.getOption=function(t){return this.name=this.name||t.toStr(this.dt.name),this.dt||t.option},e.prototype.customPipe=function(e,r,n,o){var i=this;return this.dt.pipe?Promise.resolve(t.prototype.customPipe.call(this,e,r,n,o)).then(function(t){return i.cpipe2Promise(t,i.dt,r,n,o)}):t.prototype.customPipe.call(this,e,r,n,o)},e.prototype.pipes=function(e,r,n){var o=_.isFunction(this.dt.pipes)?this.dt.pipes(e,r,n):this.dt.pipes;return o=o||[],o.concat(t.prototype.pipes.call(this,e,r,n))},e.prototype.output=function(e,r,n){if(null===this.dt.output)return[function(t){return t}];var o=_.isFunction(this.dt.output)?this.dt.output(e,r,n):this.dt.output;return o=o||[],o.concat(t.prototype.output.call(this,e,r,n))},e}(PipeTask_1.PipeTask);exports.generateTask=generateTask;
//# sourceMappingURL=sourcemaps/generateTask.js.map
