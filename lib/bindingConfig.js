"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function bindingConfig(e,t){return e.createContext?e.createContext(e,t):new TaskContext(e,t)}function currentOperation(e){var t=void 0;return t=e.deploy?TaskConfig_1.Operation.deploy:e.release?TaskConfig_1.Operation.release:TaskConfig_1.Operation.build,e.watch&&(t|=TaskConfig_1.Operation.watch),e.test&&(t|=TaskConfig_1.Operation.test),e.serve&&(t|=TaskConfig_1.Operation.serve),e.e2e&&(t|=TaskConfig_1.Operation.e2e),t}function getAssertSrc(e,t){var n=null;return(t&TaskConfig_1.Operation.test)>0?n=e.testSrc:(t&TaskConfig_1.Operation.e2e)>0?n=e.e2eSrc:(t&TaskConfig_1.Operation.watch)>0?n=e.watchSrc:(t&TaskConfig_1.Operation.clean)>0&&(n=e.cleanSrc||e.dist),n||e.src}function getCurrentDist(e,t){var n=void 0,r=t.env,a=t.oper;return r.deploy||(a&TaskConfig_1.Operation.deploy)>0?n=e.deployDist||taskStringVal(e.dist,t):r.release||(a&TaskConfig_1.Operation.release)>0?n=e.releaseDist||taskStringVal(e.dist,t):r.e2e||(a&TaskConfig_1.Operation.e2e)>0?n=e.e2eDist||e.buildDist||taskStringVal(e.dist,t):r.test||(a&TaskConfig_1.Operation.test)>0?n=e.testDist||e.buildDist||taskStringVal(e.dist,t):(a&TaskConfig_1.Operation.build)>0&&(n=e.buildDist||taskStringVal(e.dist,t)),n}function files(e,t,n){return Promise.resolve(globby(e)).then(function(e){return t&&(e=_.filter(e,t)),n&&(e=_.map(e,n)),e})}function taskSourceVal(e,t){return _.isFunction(e)?e(t):e||""}function taskStringVal(e,t){return _.isFunction(e)?e(t):e||""}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_=require("lodash"),TaskConfig_1=require("./TaskConfig"),generateTask_1=require("./generateTask"),taskSequence_1=require("./taskSequence"),utils_1=require("./utils"),decorator_1=require("./decorator"),path=require("path"),fs=require("fs"),globby=require("globby");exports.bindingConfig=bindingConfig;var globals={},TaskContext=function(){function e(t,n){_classCallCheck(this,e),this.cfg=t,this.parent=n,this.setupTasks=[],this.packages={},this.env=t.env,this.oper=currentOperation(t.env),this.option=t.option,this.globals=t.globals||globals}return _createClass(e,[{key:"matchCompare",value:function(e,t){return this.option.match?this.option.match(e,t):utils_1.matchCompare(e,t)}},{key:"getSrc",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=void 0,r=this,a=e?e.oper||r.oper:r.oper;return e&&e.assert&&(n=taskSourceVal(getAssertSrc(e.assert,a),r)),n||(n=taskSourceVal(getAssertSrc(r.option,a),r)),t!==!1?n:utils_1.absoluteSrc(r.env.root,n)}},{key:"getDist",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=void 0,r=this;return e&&e.assert&&(n=getCurrentDist(e.assert,r)),n=n||getCurrentDist(r.option,r),t!==!1?n:utils_1.absolutePath(r.env.root,n)}},{key:"subTaskName",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=this,r="";_.isString(e)?r=e:e&&e!==n.option&&(e.name&&(r=taskStringVal(e.name,n)),!r&&e.assert&&e.assert.name&&(r=taskStringVal(e.assert.name,n)));var a=taskStringVal(n.option.name,n);return a?0===r.indexOf(a+"-")?r:r&&a!==r?a+"-"+r+t:a+t:r+t}},{key:"printHelp",value:function(e){this.cfg.printHelp&&this.cfg.printHelp(e)}},{key:"findTasks",value:function(e,t){var n=this;return decorator_1.findTasksInModule(e,_.extend({oper:n.oper},t||{}),this)}},{key:"findTasksInDir",value:function(e,t){var n=this;return decorator_1.findTasksInDir(e,_.extend({oper:n.oper},t||{}),this)}},{key:"findTaskDefine",value:function(e){return decorator_1.findTaskDefineInModule(e)}},{key:"findTaskDefineInDir",value:function(e){return decorator_1.findTaskDefineInDir(e)}},{key:"fileFilter",value:function(e,t,n){return files(e,t,n)}},{key:"runSequence",value:function(e,t){return taskSequence_1.runSequence(e,t)}},{key:"generateTask",value:function(e,t){var n=this;return generateTask_1.generateTask(e,_.extend({oper:n.oper},t||{}),this)}},{key:"addToSequence",value:function(e,t){return this.cfg.addToSequence?this.cfg.addToSequence(e,t):taskSequence_1.addToSequence(e,t,this)}},{key:"getRootPath",value:function(){return this.env.root}},{key:"getRootFolders",value:function(e){return this.getFolders(this.getRootPath(),e)}},{key:"getFolders",value:function(e,t){var n=this,r=fs.readdirSync(e),a=[];return _.each(r,function(r){var i=path.join(e,r),s=fs.lstatSync(i);if(s.isDirectory())if(t){var o=t(i,n);o&&a.push(o)}else a.push(i)}),a}},{key:"getDistFolders",value:function(e,t){return this.getFolders(this.getDist(t),e)}},{key:"toRootSrc",value:function(e){return utils_1.absoluteSrc(this.cfg.env.root,e)}},{key:"toRootPath",value:function(e){return utils_1.absolutePath(this.cfg.env.root,e)}},{key:"toDistSrc",value:function(e,t){return utils_1.absoluteSrc(this.getDist(t),e)}},{key:"toDistPath",value:function(e,t){return utils_1.absolutePath(this.getDist(t),e)}},{key:"toSrc",value:function(e){return taskSourceVal(e,this)}},{key:"toStr",value:function(e){return taskStringVal(e,this)}},{key:"toUrl",value:function(e,t){return(t?path.relative(e,t):e).replace(/\\/g,"/").replace(/^\//g,"")}},{key:"getPackage",value:function(e){e=e||this.cfg.packageFile;var t=this.toRootPath(this.toStr(e)||"package.json");return this.packages[t]||(this.packages[t]=require(t)),this.packages[t]}},{key:"setup",value:function(e,t){var n=e.setup(this,t);return this.setupTasks.push(e),n}},{key:"tasks",value:function(e){return e?_.filter(this.setupTasks,e):this.setupTasks}},{key:"registerTasks",value:function(e){return this.tasks(e)}},{key:"globalTasks",value:function(){return _.keys(this.globals.tasks||{})}}]),e}();exports.TaskContext=TaskContext,exports.currentOperation=currentOperation,exports.files=files,exports.taskSourceVal=taskSourceVal,exports.taskStringVal=taskStringVal;
//# sourceMappingURL=sourcemaps/bindingConfig.js.map
