"use strict";function toSequence(e,r,t,n){var a=[],s=r.length;if(s<1)return a;var u=sortOrder_1.sortOrder(r,function(e){return e.getInfo().order},t),o=[],i=function(e){return o.push(e)};_.each(u,function(r){if(_.isArray(r)){var s=[];_.each(r,function(r){s.push(setupTask(e,r,t,i))});var u=flattenSequence(e,s,t,n);u&&u.length>0&&a.push(u)}else a=a.concat(setupTask(e,r,t,i))});var c=taskSequenceWatch(e,a,t,function(e){return!!e&&(!(o.length>0)||o.indexOf(e)<0)},n);return c&&(registerTasks(t,c),a.push(c)),a}function setupTask(e,r,t,n){var a=[],s=r.getInfo(),u=t.to(s.oper);if(u&t.oper){var o=r.setup(t,e);if(o&&(u&Operation_1.Operation.watch&&n(o),registerTasks(t,o),_.isArray(o)?a=o:a.push(o),t.oper&Operation_1.Operation.watch&&u&Operation_1.Operation.autoWatch)){var i=o+"-twatch";registerTasks(t,i),e.task(i,function(){var r=t.getSrc(s);console.log("watch, src:",chalk.cyan.call(chalk,r)),watch(r,null,function(r){runSequence(e,_.isArray(o)?o:[o])})}),n(i),a.push(i)}}return a}function registerTasks(e,r){e.globals.tasks=e.globals.tasks||{},_.isArray(r)?_.each(r,function(r){return registerGlobals(e,r)}):registerGlobals(e,r)}function hasRegistered(e,r){return e.globals.tasks=e.globals.tasks||{},!!e.globals.tasks[r]}function registerGlobals(e,r){e.globals.tasks[r]?console.error(chalk.red("has same task:"),chalk.cyan(r)):e.globals.tasks[r]=r}function taskSequenceWatch(e,r,t,n,a){if(t.oper&Operation_1.Operation.watch&&t.option.watch){var s=[],u="";if(_.isBoolean(t.option.watch)){var o=filterTaskSequence(r,n);u=zipSequence(e,o,t,a),u&&s.push(u)}else s=t.option.watch;if(s.length>0)return u=u?u+"-owatch":"owatch",e.task(u,function(){var r=t.getSrc();console.log("watch, src:",chalk.cyan.call(chalk,r)),watch(r,null,function(){runSequence(e,s)})}),u}return""}function registerZipTask(e,r,t,n){for(var a=0,s=r;hasRegistered(n,s)&&a<50;)s=r+a,console.log("try register name: ",chalk.cyan(s)),a++;return a>=50?(console.error(chalk.red("has same task:"),chalk.cyan(r),"too many times."),""):(registerGlobals(n,s),e.task(s,function(){return runSequence(e,t)}),s)}function zipSequence(e,r,t,n){if(r.length>1){var a=_.first(r);a=_.isArray(a)?_.first(a):a;var s=_.last(r);s=_.isArray(s)?_.last(s):s;var u=a+"-"+s;return u=n?n(u,RunWay_1.RunWay.sequence,t):u+"-seq",registerZipTask(e,u,r,t)}if(1===r.length){var a=_.first(r);if(_.isArray(a)){if(a.length>1){var o=_.first(a),i=_.last(a),c=o+"-"+i;return c=n?n(c,RunWay_1.RunWay.parallel,t):c+"-paral",registerZipTask(e,c,r,t)}return _.first(a)||""}return a||""}return""}function flattenSequence(e,r,t,n){var a=[];return _.each(r,function(r){if(_.isArray(r)){if(r.length<1)return;var s=_.some(r,function(e){return _.isArray(e)})?r:[r],u=zipSequence(e,s,t,n);u&&a.push(u)}else r&&a.push(r)}),a}function addToSequence(e,r,t){if(!r)return e;if(r.taskName){var n=1,a=e.length+1;if(_.isNumber(r.order))n=r.order;else if(_.isFunction(r.order)){var s=r.order(a,t);n=_.isNumber(s)?s:s.value}else r.order&&_.isNumber(r.order.value)&&(n=r.order.value);n>0&&n<1?n*=a:1===n?n=a:n>a&&(n%=a),n=parseInt(n.toFixed(0)),n<0&&(n=0);var u=a-2;n>=0&&n<=u?e.splice(n,0,r.taskName):n>u&&n<a?e.splice(u-(u-n),0,r.taskName):e.push(r.taskName)}return e}function filterTaskSequence(e,r){var t=[];return r=r||function(e){return!!e},_.each(e,function(e){e&&(_.isString(e)&&r(e)?t.push(e):_.isArray(e)&&t.push(_.filter(e,function(e){return r(e)})))}),t}function runSequence(e,r){return r=filterTaskSequence(r),console.log(chalk.cyan("run tasks : "),r),new Promise(function(t,n){var a=null;return r&&r.length>0?_.each(r,function(r){a=a?a.then(function(){return startTask(e,r)}):startTask(e,r)}):a=Promise.resolve(),a.then(t).catch(n)})}function startTask(e,r){var t=null,n=null;return new Promise(function(a,s){var u={};_.each(_.isArray(r)?r:[r],function(e){u[e]=!1}),t=function(e){s(e)},n=function(e){u[e.task]===!1&&(u[e.task]=!0),_.some(_.values(u),function(e){return!e})||a()},e.setMaxListeners&&e.setMaxListeners(100),e.on("task_stop",n).on("task_err",t),e.start(r)}).then(function(){e.removeListener&&(e.removeListener("task_stop",n),e.removeListener("task_err",t))}).catch(function(r){e.removeListener&&(e.removeListener("task_stop",n),e.removeListener("task_err",t)),process.exit(1)})}function runTaskSequence(e,r,t,n){return Promise.resolve(r).then(function(r){var a=toSequence(e,r,t,n);return runSequence(e,a)})}Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),chalk=require("chalk"),sortOrder_1=require("./utils/sortOrder"),watch=require("gulp-watch"),Operation_1=require("./Operation"),RunWay_1=require("./RunWay");exports.toSequence=toSequence,exports.taskSequenceWatch=taskSequenceWatch,exports.zipSequence=zipSequence,exports.flattenSequence=flattenSequence,exports.addToSequence=addToSequence,exports.runSequence=runSequence,exports.runTaskSequence=runTaskSequence;
//# sourceMappingURL=sourcemaps/taskSequence.js.map
