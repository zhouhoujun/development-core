"use strict";function toSequence(e,r,t){var n=[],s=r.length;if(s<1)return n;r=utils_1.sortOrder(r,function(e){return e.getInfo().order});var o=[];_.each(r,function(r){var s=r.getInfo();if(s.oper&t.oper){var a=r.setup(t,e);a&&(s.oper&TaskConfig_1.Operation.watch&&o.push(a),registerTasks(t,a),n.push(a))}});var a=taskSequenceWatch(e,n,t,function(e){return!!e&&(!(o.length>0)||o.indexOf(e)<0)});return a&&(registerTasks(t,a),n.push(a)),n}function registerTasks(e,r){e.globals.tasks=e.globals.tasks||{},_.isArray(r)?_.each(r,function(r){return registerGlobals(e,r)}):registerGlobals(e,r)}function hasRegistered(e,r){return e.globals.tasks=e.globals.tasks||{},!!e.globals.tasks[r]}function registerGlobals(e,r){e.globals.tasks[r]?(console.error(chalk.red("has same task:"),chalk.cyan(r)),process.exit(0)):e.globals.tasks[r]=r}function taskSequenceWatch(e,r,t,n){if(t.oper&TaskConfig_1.Operation.watch&&t.option.watch){var s=function(){var s=[],o="";if(_.isBoolean(t.option.watch)){var a=filterTaskSequence(r,n);o=zipSequence(e,a,t),o&&s.push(o)}else s=t.option.watch;if(s.length>0)return o=o?o+"-owatch":"owatch",e.task(o,function(){var r=t.getSrc();console.log("watch, src:",chalk.cyan.call(chalk,r)),e.watch(r,s)}),{v:o}}();if("object"===("undefined"==typeof s?"undefined":_typeof(s)))return s.v}return""}function registerZipTask(e,r,t,n){for(var s=0,o=r;hasRegistered(n,o)&&s<50;)o=r+s,console.log("try register name: ",chalk.cyan(o)),s++;return s>=50?(console.error(chalk.red("has same task:"),chalk.cyan(r),"too many times."),""):(registerGlobals(n,o),e.task(o,function(){return runSequence(e,t)}),o)}function zipSequence(e,r,t){if(r.length>1){var n=_.first(r);n=_.isArray(n)?_.first(n):n;var s=_.last(r);s=_.isArray(s)?_.last(s):s;var o=n+"-"+s+"-seq";return registerZipTask(e,o,r,t)}if(1===r.length){var a=_.first(r);if(_.isArray(a)){if(a.length>1){var u=_.first(a),i=_.last(a),c=u+"-"+i+"-paral";return registerZipTask(e,c,r,t)}return _.first(a)||""}return a||""}return""}function flattenSequence(e,r,t){var n=[];return _.each(r,function(r){if(_.isArray(r)){var s=_.some(r,function(e){return _.isArray(e)})?r:[r],o=zipSequence(e,s,t);o&&n.push(o)}else n.push(r)}),n}function addToSequence(e,r){if(!r)return e;if(r.taskName){var t=1,n=e.length+1;_.isNumber(r.order)?t=r.order:_.isFunction(r.order)&&(t=r.order(n)),_.isNumber(t)&&(t>0&&t<1?t=Math.round(t*n):1===t?t=n:t>n&&(t=Math.round(t%n))),t<0&&(t=0),t>=0&&t<e.length?e.splice(t,0,r.taskName):e.push(r.taskName)}return e}function filterTaskSequence(e,r){var t=[];return r=r||function(e){return!!e},_.each(e,function(e){e&&(_.isString(e)&&r(e)?t.push(e):_.isArray(e)&&t.push(_.filter(e,function(e){return r(e)})))}),t}function runSequence(e,r){r=filterTaskSequence(r),console.log("run tasks : ",chalk.cyan(r));var t=new Promise(function(t,n){var s=null;return r&&r.length>0?_.each(r,function(r){s=s?s.then(function(){return startTask(e,r)}):startTask(e,r)}):s=Promise.resolve(),s.then(t).catch(n)});return t.catch(function(e){console.error(chalk.red(e))})}function startTask(e,r){var t=null,n=null;return new Promise(function(s,o){var a={};_.each(_.isArray(r)?r:[r],function(e){a[e]=!1}),t=function(e){process.exit(e),console.error(chalk.red(e)),o(e)},n=function(e){a[e.task]=!0,_.some(_.values(a),function(e){return!e})||s()},e.on("task_stop",n).on("task_err",t),e.start(r)}).then(function(){e.removeListener&&(e.removeListener("task_stop",n),e.removeListener("task_err",t))},function(r){e.removeListener&&(e.removeListener("task_stop",n),e.removeListener("task_err",t))})}function runTaskSequence(e,r,t){return Promise.resolve(r).then(function(r){var n=toSequence(e,r,t);return runSequence(e,n)})}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_=require("lodash"),chalk=require("chalk"),TaskConfig_1=require("./TaskConfig"),utils_1=require("./utils");exports.toSequence=toSequence,exports.taskSequenceWatch=taskSequenceWatch,exports.zipSequence=zipSequence,exports.flattenSequence=flattenSequence,exports.addToSequence=addToSequence,exports.runSequence=runSequence,exports.runTaskSequence=runTaskSequence;
//# sourceMappingURL=sourcemaps/taskSequence.js.map
