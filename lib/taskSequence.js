"use strict";function toSequence(e,r,n){var t=[],o=r.length;if(o<1)return t;r=_.orderBy(r,function(e){if(_.isArray(e))return o;var r=e.getInfo();return _.isNumber(r.order)?r.order:_.isFunction(r.order)?r.order(o):o});var s=[];_.each(r,function(r){var o=r.getInfo();if(o.oper&n.oper){var a=r.setup(n,e);a&&(o.oper&TaskConfig_1.Operation.watch&&s.push(a),registerTasks(n,a),t.push(a))}});var a=taskSequenceWatch(e,t,n,function(e){return!!e&&(!(s.length>0)||s.indexOf(e)<0)});return a&&(registerTasks(n,a),t.push(a)),t}function registerTasks(e,r){e.globals.tasks=e.globals.tasks||{},_.isArray(r)?_.each(r,function(r){return registerGlobals(e,r)}):registerGlobals(e,r)}function registerGlobals(e,r){e.globals.tasks[r]?(console.error(chalk.red("has same task:"),chalk.cyan(r)),process.exit(0)):e.globals.tasks[r]=r}function taskSequenceWatch(e,r,n,t){if(n.oper&TaskConfig_1.Operation.watch&&n.option.watch){var o=function(){var o=[],s="";if(_.isBoolean(n.option.watch)?!function(){var n=filterTaskSequence(r,t);if(n.length>1){var a=_.first(n);a=_.isArray(a)?_.first(a):a;var u=_.last(n);u=_.isArray(u)?_.last(u):u,s=a+"-"+u;var c=s+"-seq";e.task(c,function(){return runSequence(e,n)}),o.push(c)}else if(1===n.length){var i=_.first(n);if(_.isArray(i)){var f=_.first(i),l=_.last(i);s=f+"-"+l,o=i}else i&&(s=i,o.push(i))}}():o=n.option.watch,o.length>0)return s=s?s+"-owatch":"owatch",e.task(s,function(){var r=n.getSrc();console.log("watch, src:",chalk.cyan.call(chalk,r)),e.watch(r,o)}),{v:s}}();if("object"===("undefined"==typeof o?"undefined":_typeof(o)))return o.v}return""}function addToSequence(e,r){if(!r)return e;if(r.taskName){var n=e.length;_.isNumber(r.order)?n=r.order:_.isFunction(r.order)&&(n=r.order(n)),n>=0&&n<e.length?e.splice(n,0,r.taskName):e.push(r.taskName)}return e}function filterTaskSequence(e,r){var n=[];return r=r||function(e){return!!e},_.each(e,function(e){e&&(_.isString(e)&&r(e)?n.push(e):_.isArray(e)&&n.push(_.filter(e,function(e){return r(e)})))}),n}function runSequence(e,r){r=filterTaskSequence(r),console.log("run tasks : ",chalk.cyan(r));var n=new Promise(function(n,t){var o=null;return r&&r.length>0?_.each(r,function(r){o=o?o.then(function(){return startTask(e,r)}):startTask(e,r)}):o=Promise.resolve(),o.then(n).catch(t)});return n.catch(function(e){console.error(chalk.red(e))})}function startTask(e,r){var n=null,t=null;return new Promise(function(o,s){var a={};_.each(_.isArray(r)?r:[r],function(e){a[e]=!1}),n=function(e){process.exit(e),console.error(chalk.red(e)),s(e)},t=function(e){a[e.task]=!0,_.some(_.values(a),function(e){return!e})||o()},e.on("task_stop",t).on("task_err",n),e.start(r)}).then(function(){e.removeListener&&(e.removeListener("task_stop",t),e.removeListener("task_err",n))},function(r){e.removeListener&&(e.removeListener("task_stop",t),e.removeListener("task_err",n))})}function runTaskSequence(e,r,n){return Promise.resolve(r).then(function(r){var t=toSequence(e,r,n);return runSequence(e,t)})}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_=require("lodash"),chalk=require("chalk"),TaskConfig_1=require("./TaskConfig");exports.toSequence=toSequence,exports.taskSequenceWatch=taskSequenceWatch,exports.addToSequence=addToSequence,exports.runSequence=runSequence,exports.runTaskSequence=runTaskSequence;
//# sourceMappingURL=sourcemaps/taskSequence.js.map
