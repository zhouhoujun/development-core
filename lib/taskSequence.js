"use strict";function toSequence(e,r,t){var n=[],o=r.length;if(o<1)return n;r=utils_1.sortOrder(r,function(e){return e.getInfo().order});var s=[];_.each(r,function(r){var o=r.getInfo();if(o.oper&t.oper){var a=r.setup(t,e);a&&(o.oper&TaskConfig_1.Operation.watch&&s.push(a),registerTasks(t,a),n.push(a))}});var a=taskSequenceWatch(e,n,t,function(e){return!!e&&(!(s.length>0)||s.indexOf(e)<0)});return a&&(registerTasks(t,a),n.push(a)),n}function registerTasks(e,r){e.globals.tasks=e.globals.tasks||{},_.isArray(r)?_.each(r,function(r){return registerGlobals(e,r)}):registerGlobals(e,r)}function registerGlobals(e,r){e.globals.tasks[r]?(console.error(chalk.red("has same task:"),chalk.cyan(r)),process.exit(0)):e.globals.tasks[r]=r}function taskSequenceWatch(e,r,t,n){if(t.oper&TaskConfig_1.Operation.watch&&t.option.watch){var o=function(){var o=[],s="";if(_.isBoolean(t.option.watch)?!function(){var t=filterTaskSequence(r,n);if(t.length>1){var a=_.first(t);a=_.isArray(a)?_.first(a):a;var u=_.last(t);u=_.isArray(u)?_.last(u):u,s=a+"-"+u;var c=s+"-seq";e.task(c,function(){return runSequence(e,t)}),o.push(c)}else if(1===t.length){var i=_.first(t);if(_.isArray(i)){var l=_.first(i),f=_.last(i);s=l+"-"+f,o=i}else i&&(s=i,o.push(i))}}():o=t.option.watch,o.length>0)return s=s?s+"-owatch":"owatch",e.task(s,function(){var r=t.getSrc();console.log("watch, src:",chalk.cyan.call(chalk,r)),e.watch(r,o)}),{v:s}}();if("object"===("undefined"==typeof o?"undefined":_typeof(o)))return o.v}return""}function addToSequence(e,r){if(!r)return e;if(r.taskName){var t=e.length;_.isNumber(r.order)?t=r.order:_.isFunction(r.order)&&(t=r.order(t)),_.isNumber(t)&&(t>0&&t<1?t*=e.length:t>e.length&&(t%=e.length)),t>=0&&t<e.length?e.splice(t,0,r.taskName):e.push(r.taskName)}return e}function filterTaskSequence(e,r){var t=[];return r=r||function(e){return!!e},_.each(e,function(e){e&&(_.isString(e)&&r(e)?t.push(e):_.isArray(e)&&t.push(_.filter(e,function(e){return r(e)})))}),t}function runSequence(e,r){r=filterTaskSequence(r),console.log("run tasks : ",chalk.cyan(r));var t=new Promise(function(t,n){var o=null;return r&&r.length>0?_.each(r,function(r){o=o?o.then(function(){return startTask(e,r)}):startTask(e,r)}):o=Promise.resolve(),o.then(t).catch(n)});return t.catch(function(e){console.error(chalk.red(e))})}function startTask(e,r){var t=null,n=null;return new Promise(function(o,s){var a={};_.each(_.isArray(r)?r:[r],function(e){a[e]=!1}),t=function(e){process.exit(e),console.error(chalk.red(e)),s(e)},n=function(e){a[e.task]=!0,_.some(_.values(a),function(e){return!e})||o()},e.on("task_stop",n).on("task_err",t),e.start(r)}).then(function(){e.removeListener&&(e.removeListener("task_stop",n),e.removeListener("task_err",t))},function(r){e.removeListener&&(e.removeListener("task_stop",n),e.removeListener("task_err",t))})}function runTaskSequence(e,r,t){return Promise.resolve(r).then(function(r){var n=toSequence(e,r,t);return runSequence(e,n)})}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_=require("lodash"),chalk=require("chalk"),TaskConfig_1=require("./TaskConfig"),utils_1=require("./utils");exports.toSequence=toSequence,exports.taskSequenceWatch=taskSequenceWatch,exports.addToSequence=addToSequence,exports.runSequence=runSequence,exports.runTaskSequence=runTaskSequence;
//# sourceMappingURL=sourcemaps/taskSequence.js.map
