"use strict";function bindingConfig(t,e){return createContext(t,e)}function createContext(t,e){return t.createContext?t.createContext(t,e):new TaskContext(t,e)}function currentOperation(t){var e;return e=t.deploy?TaskConfig_1.Operation.deploy|TaskConfig_1.Operation.release:t.release?TaskConfig_1.Operation.release:TaskConfig_1.Operation.build,t.watch&&(e|=TaskConfig_1.Operation.watch),t.test&&(e|=TaskConfig_1.Operation.test),t.serve&&(e|=TaskConfig_1.Operation.serve),t.e2e&&(e|=TaskConfig_1.Operation.e2e),e}function getAssertSrc(t,e){var r=null;return(e&TaskConfig_1.Operation.test)>0?r=t.testSrc:(e&TaskConfig_1.Operation.e2e)>0?r=t.e2eSrc:(e&TaskConfig_1.Operation.watch)>0?r=t.watchSrc:(e&TaskConfig_1.Operation.clean)>0&&(r=t.cleanSrc||t.dist),r||t.src}function getCurrentDist(t,e){var r,n=e.env,o=e.oper;return(n.deploy||(o&TaskConfig_1.Operation.deploy)>0)&&(r=taskStringVal(t.deployDist,e)),!r&&(n.release||(o&TaskConfig_1.Operation.release)>0)&&(r=taskStringVal(t.releaseDist,e)),!r&&(n.e2e||(o&TaskConfig_1.Operation.e2e)>0)&&(r=taskStringVal(t.e2eDist,e)),!r&&(n.test||(o&TaskConfig_1.Operation.test)>0)&&(r=taskStringVal(t.testDist,e)),!r&&(o&TaskConfig_1.Operation.build)>0&&(r=taskStringVal(t.buildDist,e)),r||(r=taskStringVal(t.dist,e)),r}function files(t,e,r){return Promise.resolve(globby(t)).then(function(t){return e&&(t=_.filter(t,e)),r&&(t=_.map(t,r)),t})}function taskSourceVal(t,e){return _.isFunction(t)?t(e):t||""}function taskStringVal(t,e){return _.isFunction(t)?t(e):t||""}Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),gulp=require("gulp"),TaskConfig_1=require("./TaskConfig"),generateTask_1=require("./generateTask"),taskSequence_1=require("./taskSequence"),utils_1=require("./utils"),decorator_1=require("./decorator"),path=require("path"),fs=require("fs"),globby=require("globby");exports.bindingConfig=bindingConfig,exports.createContext=createContext;var globals={},TaskContext=function(){function t(t,e){this.parent=e,this.setupTasks=[],this.children=[],this.packages={},this.loadConfig(t)}return Object.defineProperty(t.prototype,"gulp",{get:function(){return this._gulp||gulp},set:function(t){this._gulp=t},enumerable:!0,configurable:!0}),t.prototype.add=function(t){t.parent=this,this.children.push(t)},t.prototype.remove=function(t){var e=_.remove(this.children,t);return _.each(e,function(t){t&&(t.parent=null)}),e},t.prototype.loadConfig=function(t){this.env=_.extend(t.env,this.env||{}),this.oper=t.oper||currentOperation(t.env),this.globals=t.globals||globals,this.option=_.extend(t.option,this.option||{}),this.cfg=_.extend(t,this.cfg)},t.prototype.getConfig=function(){return this.cfg},t.prototype.find=function(t,e){var r;return this.each(function(e){if(r)return!1;var n=_.isFunction(t)?t(e):t===e;return!n||(r=e,!1)},e),r},t.prototype.filter=function(t,e){var r=[];return this.each(function(e){t(e)&&r.push(e)},e),r},t.prototype.each=function(t,e){e=e||TaskConfig_1.Mode.traverse;var r;switch(e){case TaskConfig_1.Mode.route:r=this.route(t);break;case TaskConfig_1.Mode.children:r=this.eachChildren(t);break;case TaskConfig_1.Mode.traverse:r=this.trans(t);break;default:r=this.trans(t)}return r},t.prototype.map=function(t,e,r){var n=[];return this.each(function(e){r?r(e)&&n.push(t(e)):n.push(t(e))},e),n},t.prototype.eachChildren=function(t){_.each(this.children,function(e){return t(e)})},t.prototype.route=function(t){return!!t(this)&&(this.parent&&this.parent.route?this.parent.route(t):void 0)},t.prototype.trans=function(t){return t(this)!==!1&&(_.each(this.children,function(e){return e.trans(t)}),!0)},t.prototype.matchCompare=function(t,e){return this.option.match?this.option.match(t,e):utils_1.matchCompare(t,e)},t.prototype.getSrc=function(t,e){void 0===e&&(e=!1);var r,n=this,o=t?t.oper||n.oper:n.oper;return t&&t.assert&&(r=taskSourceVal(getAssertSrc(t.assert,o),n)),r||this.route(function(t){return r=taskSourceVal(getAssertSrc(t.option,o),t),!r}),e!==!1?r:utils_1.absoluteSrc(n.env.root,r)},t.prototype.getDist=function(t,e){void 0===e&&(e=!1);var r,n=this;return t&&t.assert&&(r=getCurrentDist(t.assert,n)),r||this.route(function(t){return r=getCurrentDist(t.option,t),!r}),e!==!1?r:utils_1.absolutePath(n.env.root,r)},t.prototype.subTaskName=function(t,e){void 0===e&&(e="");var r=this,n="";_.isString(t)?n=t:t&&t!==r.option&&(t.name&&(n=taskStringVal(t.name,r)),!n&&t.assert&&t.assert.name&&(n=taskStringVal(t.assert.name,r)));var o;return this.route(function(t){return o=taskStringVal(t.option.name,t),!o}),o?0===n.indexOf(o+"-")?n:n&&o!==n?o+"-"+n+e:o+e:n+e},t.prototype.printHelp=function(t){this.cfg.printHelp&&this.cfg.printHelp(t)},t.prototype.findTasks=function(t,e){var r=this;return decorator_1.findTasksInModule(t,_.extend({oper:r.oper},e||{}),this)},t.prototype.findTasksInDir=function(t,e){var r=this;return decorator_1.findTasksInDir(r.to(t),_.extend({oper:r.oper},e||{}),this)},t.prototype.findTaskDefine=function(t){return decorator_1.findTaskDefineInModule(t)},t.prototype.findTaskDefineInDir=function(t){return decorator_1.findTaskDefineInDir(this.to(t))},t.prototype.fileFilter=function(t,e,r){return files(t,e,r)},t.prototype.toSequence=function(t,e){return taskSequence_1.toSequence(this.gulp,t,this,e)},t.prototype.runSequence=function(t){return taskSequence_1.runSequence(this.gulp,t)},t.prototype.runTaskSequence=function(t,e){return taskSequence_1.runTaskSequence(this.gulp,t,this,e)},t.prototype.zipSequence=function(t,e){return taskSequence_1.zipSequence(this.gulp,t,this,e)},t.prototype.flattenSequence=function(t,e){return taskSequence_1.flattenSequence(this.gulp,t,this,e)},t.prototype.generateTask=function(t,e){var r=this;return generateTask_1.generateTask(t,_.extend({oper:r.oper},e||{}),this)},t.prototype.addToSequence=function(t,e){return this.cfg.addToSequence?this.cfg.addToSequence(t,e):taskSequence_1.addToSequence(t,e,this)},t.prototype.getRootPath=function(){return this.env.root},t.prototype.getRootFolders=function(t){return this.getFolders(this.getRootPath(),t)},t.prototype.getFolders=function(t,e){var r=this,n=fs.readdirSync(t),o=[];return _.each(n,function(n){var i=path.join(t,n),s=fs.lstatSync(i);if(s.isDirectory())if(e){var a=e(i,n,r);a&&o.push(a)}else o.push(i)}),o},t.prototype.getDistFolders=function(t,e){return this.getFolders(this.getDist(e),t)},t.prototype.toRootSrc=function(t){return utils_1.absoluteSrc(this.cfg.env.root,t)},t.prototype.toRootPath=function(t){return utils_1.absolutePath(this.cfg.env.root,t)},t.prototype.toDistSrc=function(t,e){return utils_1.absoluteSrc(this.getDist(e),t)},t.prototype.toDistPath=function(t,e){return utils_1.absolutePath(this.getDist(e),t)},t.prototype.to=function(t){return _.isFunction(t)?t(this):t},t.prototype.toSrc=function(t){return taskSourceVal(t,this)},t.prototype.toStr=function(t){return taskStringVal(t,this)},t.prototype.toUrl=function(t,e){return(e?path.relative(t,e):t).replace(/\\/g,"/")},t.prototype.getPackage=function(t){t=t||this.cfg.packageFile;var e=this.toRootPath(this.toStr(t)||"package.json");return this.packages[e]||(this.packages[e]=require(e)),this.packages[e]},t.prototype.setup=function(t,e){var r=t.setup(this,e);return this.setupTasks.push(t),r},t.prototype.tasks=function(t){return t?_.filter(this.setupTasks,t):this.setupTasks},t.prototype.registerTasks=function(t){var e=[];return this.each(function(r){e=e.concat(r.tasks(t))}),e},t.prototype.globalTasks=function(){return _.keys(this.globals.tasks||{})},t}();exports.TaskContext=TaskContext,exports.currentOperation=currentOperation,exports.files=files,exports.taskSourceVal=taskSourceVal,exports.taskStringVal=taskStringVal;
//# sourceMappingURL=sourcemaps/TaskContext.js.map
