"use strict";function bindingConfig(t,e){return createContext(t,e)}function createContext(t,e){var n=t&&t.option?t:{option:t};return n.createContext?n.createContext(t,e):e?e.add(n):new TaskContext(n)}function currentOperation(t){var e;return e=t.deploy?TaskConfig_1.Operation.deploy|TaskConfig_1.Operation.release:t.release?TaskConfig_1.Operation.release:TaskConfig_1.Operation.build,t.watch&&(e|=TaskConfig_1.Operation.watch),t.test&&(e|=TaskConfig_1.Operation.test),t.serve&&(e|=TaskConfig_1.Operation.serve),t.e2e&&(e|=TaskConfig_1.Operation.e2e),e}function getAssertSrc(t,e){var n=null;return(e&TaskConfig_1.Operation.test)>0?n=t.testSrc:(e&TaskConfig_1.Operation.e2e)>0?n=t.e2eSrc:(e&TaskConfig_1.Operation.watch)>0?n=t.watchSrc:(e&TaskConfig_1.Operation.clean)>0&&(n=t.cleanSrc||t.dist),n||t.src}function getCurrentDist(t,e){var n,r=e.env,o=e.oper;return(r.deploy||(o&TaskConfig_1.Operation.deploy)>0)&&(n=taskStringVal(t.deployDist,e)),!n&&(r.release||(o&TaskConfig_1.Operation.release)>0)&&(n=taskStringVal(t.releaseDist,e)),!n&&(r.e2e||(o&TaskConfig_1.Operation.e2e)>0)&&(n=taskStringVal(t.e2eDist,e)),!n&&(r.test||(o&TaskConfig_1.Operation.test)>0)&&(n=taskStringVal(t.testDist,e)),!n&&(o&TaskConfig_1.Operation.build)>0&&(n=taskStringVal(t.buildDist,e)),n||(n=taskStringVal(t.dist,e)),n}function files(t,e,n){return Promise.resolve(globby(t)).then(function(t){return e&&(t=_.filter(t,e)),n&&(t=_.map(t,n)),t})}function taskSourceVal(t,e){return _.isFunction(t)?t(e):t||""}function taskStringVal(t,e){return _.isFunction(t)?t(e):t||""}Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),gulp=require("gulp"),minimist=require("minimist"),TaskConfig_1=require("./TaskConfig"),generateTask_1=require("./generateTask"),taskSequence_1=require("./taskSequence"),utils_1=require("./utils"),findTasks_1=require("./findTasks"),path=require("path"),fs=require("fs"),globby=require("globby");exports.bindingConfig=bindingConfig,exports.createContext=createContext;var NULLBuilder={build:function(t,e){return t},isBuilt:function(t){return!1}},globals={},TaskContext=function(){function t(t){this.taskseq=[],this.sequence=[],this.children=[],this.packages={},t=t||{},t.env=t.env||this.createEnv(),this.setConfig(t)}return Object.defineProperty(t.prototype,"gulp",{get:function(){return this._gulp||gulp},set:function(t){this._gulp=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"builder",{get:function(){return this._builder||NULLBuilder},set:function(t){this._builder=t},enumerable:!0,configurable:!0}),t.prototype.createEnv=function(){var t=minimist(process.argv.slice(2),{string:"env",default:{env:process.env.NODE_ENV||"development"}});return t},t.prototype.setEnvViaOperate=function(t){this.env=this.env||{},(t&TaskConfig_1.Operation.deploy)>0?(this.env.deploy=!0,this.env.release=!1):(t&TaskConfig_1.Operation.release)>0&&(this.env.release=!0,this.env.deploy=!1,t=TaskConfig_1.Operation.release),(t&TaskConfig_1.Operation.watch)>0&&(this.env.watch=!0),(t&TaskConfig_1.Operation.test)>0&&(this.env.test=!0),(t&TaskConfig_1.Operation.serve)>0&&(this.env.serve=!0),(t&TaskConfig_1.Operation.e2e)>0&&(this.env.e2e=!0)},t.prototype.setConfig=function(t){t&&(t.env&&(this.env=t.env=_.extend({},this.env||{},t.env),this.oper=currentOperation(this.env)),this.env.root||(this.env.root=this.getRootPath()),t.oper&&(this.oper=t.oper,this.setEnvViaOperate(this.oper)),this.globals=t.globals||globals,t.option&&(this.option=t.option=_.extend({},this.option||{},t.option)),this.cfg=_.extend(this.cfg,t))},t.prototype.getConfig=function(){return this.cfg||{}},t.prototype.isConfig=function(t){return t&&t.option},t.prototype.add=function(e){var n,r=_.omit(this.getConfig(),"option");if(e instanceof t)n=e,n.parent&&n.parent.remove(n),n.setConfig(_.extend({},r,n.getConfig()));else{var o=this.isConfig(e)?e:{option:e};o=_.extend({},r,o),n=this.createContext(o)}return n.parent=this,this.children.push(n),n},t.prototype.createContext=function(e){return new t(e)},t.prototype.remove=function(t){var e=_.remove(this.children,t);return _.each(e,function(t){t&&(t.parent=null)}),e},t.prototype.isTask=function(t){return!!t&&(!!_.isFunction(t)&&(t.__task||t.__dynamictask))},t.prototype.find=function(t,e){var n;return this.each(function(e){if(n)return!1;var r=_.isFunction(t)?t(e):t===e;return!r||(n=e,!1)},e),n},t.prototype.filter=function(t,e){var n=[];return this.each(function(e){t(e)&&n.push(e)},e),n},t.prototype.each=function(t,e){e=e||TaskConfig_1.Mode.traverse;var n;switch(e){case TaskConfig_1.Mode.route:n=this.route(t);break;case TaskConfig_1.Mode.children:n=this.eachChildren(t);break;case TaskConfig_1.Mode.traverse:n=this.trans(t);break;default:n=this.trans(t)}return n},t.prototype.map=function(t,e,n){var r=[];return this.each(function(e){n?n(e)&&r.push(t(e)):r.push(t(e))},e),r},t.prototype.eachChildren=function(t){_.each(this.children,function(e){return t(e)})},t.prototype.route=function(t){return t(this)!==!1&&(this.parent&&this.parent.route?this.parent.route(t):void 0)},t.prototype.trans=function(t){return t(this)!==!1&&(_.each(this.children,function(e){return e.trans(t)}),!0)},t.prototype.matchCompare=function(t,e){return this.option.match?this.option.match(t,e):utils_1.matchCompare(t,e)},t.prototype.getSrc=function(t,e){void 0===e&&(e=!1);var n,r=this,o=t?t.oper||r.oper:r.oper;return t&&t.assert&&(n=taskSourceVal(getAssertSrc(t.assert,o),r)),n||this.route(function(t){return n=taskSourceVal(getAssertSrc(t.option,o),t),!n}),e!==!1?n:utils_1.absoluteSrc(r.env.root,n)},t.prototype.getDist=function(t,e){void 0===e&&(e=!1);var n,r=this;return t&&t.assert&&(n=getCurrentDist(t.assert,r)),n||this.route(function(t){return n=getCurrentDist(t.option,t),!n}),e!==!1?n:utils_1.absolutePath(r.env.root,n)},t.prototype.subTaskName=function(t,e){return this.taskName(t,e)},t.prototype.taskName=function(t,e){void 0===e&&(e="");var n=this,r="",o=_.filter(this.map(function(t){return t.toStr(t.option.name)},TaskConfig_1.Mode.route),function(t){return!!t}).reverse();return _.isString(t)?r=t:t&&t!==n.option&&(t.name&&(r=taskStringVal(t.name,n)),!r&&t.assert&&t.assert.name&&(r=taskStringVal(t.assert.name,n))),r&&o.push(r),e&&o.push(e),o.join("-")},t.prototype.findTasks=function(t,e){var n=this;return findTasks_1.findTasksInModule(t,_.extend({oper:n.oper},e||{}),this)},t.prototype.findTasksInDir=function(t,e){var n=this;return findTasks_1.findTasksInDir(n.to(t),_.extend({oper:n.oper},e||{}),this)},t.prototype.findTaskDefine=function(t){return findTasks_1.findTaskDefineInModule(t)},t.prototype.findTaskDefineInDir=function(t){return findTasks_1.findTaskDefineInDir(this.to(t))},t.prototype.fileFilter=function(t,e,n){return files(t,e,n)},t.prototype.toSequence=function(t,e){return taskSequence_1.toSequence(this.gulp,t,this,e)},t.prototype.runSequence=function(t){return taskSequence_1.runSequence(this.gulp,t)},t.prototype.runTaskSequence=function(t,e){return taskSequence_1.runTaskSequence(this.gulp,t,this,e)},t.prototype.zipSequence=function(t,e){return taskSequence_1.zipSequence(this.gulp,t,this,e)},t.prototype.flattenSequence=function(t,e){return taskSequence_1.flattenSequence(this.gulp,t,this,e)},t.prototype.generateTask=function(t,e){var n=this,r=generateTask_1.generateTask(t,_.extend({oper:n.oper},e||{}),this);return this.taskseq=this.taskseq.concat(r),this.taskseq},t.prototype.addToSequence=function(t,e){return this.cfg.addToSequence?this.cfg.addToSequence(t,e):taskSequence_1.addToSequence(t,e,this)},t.prototype.getRootPath=function(){var t,e=this;return this.env&&this.env.root?t=this.env.root:this.each(function(n){return!n.env||!n.env.root||(t=e.env.root,!1)},TaskConfig_1.Mode.route),t},t.prototype.getRootFolders=function(t){return this.getFolders(this.getRootPath(),t)},t.prototype.getFolders=function(t,e){var n=this,r=fs.readdirSync(t),o=[];return _.each(r,function(r){var i=path.join(t,r),s=fs.lstatSync(i);if(s.isDirectory())if(e){var a=e(i,r,n);a&&o.push(a)}else o.push(i)}),o},t.prototype.getDistFolders=function(t,e){return this.getFolders(this.getDist(e),t)},t.prototype.toRootSrc=function(t){return utils_1.absoluteSrc(this.getRootPath(),t)},t.prototype.toRootPath=function(t){return utils_1.absolutePath(this.getRootPath(),t)},t.prototype.toDistSrc=function(t,e){return utils_1.absoluteSrc(this.getDist(e),t)},t.prototype.toDistPath=function(t,e){return utils_1.absolutePath(this.getDist(e),t)},t.prototype.to=function(t){return _.isFunction(t)?t(this):t},t.prototype.toSrc=function(t){return taskSourceVal(t,this)},t.prototype.toStr=function(t){return taskStringVal(t,this)},t.prototype.toUrl=function(t,e){return(e?path.relative(t,e):t).replace(/\\/g,"/")},t.prototype.getPackage=function(t){t=t||this.cfg.packageFile;var e=this.toRootPath(this.toStr(t)||"package.json");return this.packages[e]||(this.packages[e]=require(e)),this.packages[e]},t.prototype.setup=function(){var t=this;return this.option.oper&&(this.oper&this.option.oper)<=0?(this.sequence=null,Promise.resolve(this.sequence)):Promise.resolve(this.setupTasks()).then(function(e){return t.builder.isBuilt(t)||t.builder.build(t),Promise.all(t.map(function(t){return t.setup().then(function(e){return t})},TaskConfig_1.Mode.children)).then(function(t){return{tseq:e,subtasks:t}})}).then(function(e){var n=t.option,r=e.tseq,o=utils_1.sortOrder(e.subtasks,function(t){return t.option.order},t),i=[];return _.each(o,function(e,n){if(_.isArray(e)){if(e.length>0){var r=_.filter(_.map(e,function(e){return t.zipSequence(e.getRunSequence())}),function(t){return!!t});r.length>0&&i.push(r)}}else{var o=t.zipSequence(e.getRunSequence());o&&i.push(o)}}),i=t.flattenSequence(i),r=t.flattenSequence(r),r.length>0?(r=n.runWay===TaskConfig_1.RunWay.parallel?[t.flattenSequence(r)]:t.flattenSequence(r),i&&i.length>0&&(n.nodeSequence===TaskConfig_1.NodeSequence.after?r.splice.apply(r,[0,0].concat(i)):r.push.apply(r,i))):r=i,t.sequence=r,t.sequence})},t.prototype.getRunSequence=function(){return this.sequence||[]},t.prototype.setupTasks=function(){return this.toSequence(this.taskseq)},t.prototype.addTask=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];(n=this.taskseq).push.apply(n,t);var n},t.prototype.removeTask=function(t){var e=this.taskseq.indexOf(t);return e>=0&&e<this.taskseq.length?this.taskseq.splice(e,1):[]},t.prototype.run=function(){var t=this;return this.env.help?Promise.resolve(this.help()):this.setup().then(function(e){var n=t.option;return n.runWay===TaskConfig_1.RunWay.parallel?t.runSequence([t.flattenSequence(e)]):t.runSequence(e)})},t.prototype.help=function(){this.cfg.printHelp&&this.cfg.printHelp(_.isBoolean(this.env.help)?"":this.env.help)},t.prototype.tasks=function(t){return t?_.filter(this.taskseq,t):this.taskseq},t.prototype.registerTasks=function(t){var e=[];return this.each(function(n){e=e.concat(n.tasks(t))}),e},t.prototype.globalTasks=function(){return _.keys(this.globals.tasks||{})},t}();exports.TaskContext=TaskContext;
//# sourceMappingURL=sourcemaps/TaskContext.js.map
