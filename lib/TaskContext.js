"use strict";function bindingConfig(t,e){return createContext(t,e)}function createContext(t,e){var n=t&&t.option?t:{option:t};return n.createContext?n.createContext(t,e):e?e.add(n):new TaskContext(n)}function currentOperation(t){var e;return e=t.deploy?TaskConfig_1.Operation.deploy|TaskConfig_1.Operation.release:t.release?TaskConfig_1.Operation.release:TaskConfig_1.Operation.build,t.watch&&(e|=TaskConfig_1.Operation.watch),t.test&&(e|=TaskConfig_1.Operation.test),t.serve&&(e|=TaskConfig_1.Operation.serve),t.e2e&&(e|=TaskConfig_1.Operation.e2e),e}function getAssertSrc(t,e){var n=null;return(e&TaskConfig_1.Operation.test)>0?n=t.testSrc:(e&TaskConfig_1.Operation.e2e)>0?n=t.e2eSrc:(e&TaskConfig_1.Operation.watch)>0?n=t.watchSrc:(e&TaskConfig_1.Operation.clean)>0&&(n=t.cleanSrc||t.dist),n||t.src}function getCurrentDist(t,e){var n,o=e.env,r=e.oper;return(o.deploy||(r&TaskConfig_1.Operation.deploy)>0)&&(n=taskStringVal(t.deployDist,e)),!n&&(o.release||(r&TaskConfig_1.Operation.release)>0)&&(n=taskStringVal(t.releaseDist,e)),!n&&(o.e2e||(r&TaskConfig_1.Operation.e2e)>0)&&(n=taskStringVal(t.e2eDist,e)),!n&&(o.test||(r&TaskConfig_1.Operation.test)>0)&&(n=taskStringVal(t.testDist,e)),!n&&(r&TaskConfig_1.Operation.build)>0&&(n=taskStringVal(t.buildDist,e)),n||(n=taskStringVal(t.dist,e)),n}function files(t,e,n){return Promise.resolve(globby(t)).then(function(t){return e&&(t=_.filter(t,e)),n&&(t=_.map(t,n)),t})}function taskSourceVal(t,e){return _.isFunction(t)?t(e):t||""}function taskStringVal(t,e){return _.isFunction(t)?t(e):t||""}Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),gulp=require("gulp"),chalk=require("chalk"),child_process_1=require("child_process"),minimist=require("minimist"),TaskConfig_1=require("./TaskConfig"),generateTask_1=require("./generateTask"),taskSequence_1=require("./taskSequence"),utils_1=require("./utils"),findTasks_1=require("./findTasks"),path=require("path"),fs=require("fs"),globby=require("globby");exports.bindingConfig=bindingConfig,exports.createContext=createContext;var NULLBuilder={build:function(t,e){return t},isBuilt:function(t){return!1}},globals={},TaskContext=function(){function t(t){this.taskseq=[],this.sequence=[],this.children=[],this.packages={},t=t||{},t.env=t.env||this.createEnv(),this.setConfig(t)}return Object.defineProperty(t.prototype,"gulp",{get:function(){return this._gulp||gulp},set:function(t){this._gulp=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"builder",{get:function(){return this._builder||NULLBuilder},set:function(t){this._builder=t},enumerable:!0,configurable:!0}),t.prototype.createEnv=function(){var t=minimist(process.argv.slice(2),{string:"env",default:{env:process.env.NODE_ENV||"development"}});return t},t.prototype.setEnvViaOperate=function(t){this.env=this.env||{},(t&TaskConfig_1.Operation.deploy)>0?(this.env.deploy=!0,this.env.release=void 0):(t&TaskConfig_1.Operation.release)>0&&(this.env.release=!0,this.env.deploy=void 0,t=TaskConfig_1.Operation.release),(t&TaskConfig_1.Operation.watch)>0&&(this.env.watch=!0),(t&TaskConfig_1.Operation.test)>0&&(this.env.test=!0),(t&TaskConfig_1.Operation.serve)>0&&(this.env.serve=!0),(t&TaskConfig_1.Operation.e2e)>0&&(this.env.e2e=!0)},t.prototype.setConfig=function(t){t&&(t.env&&(this.env=t.env=_.extend({},this.env||{},t.env),this.oper=currentOperation(this.env)),this.env.root||(this.env.root=this.getRootPath()),t.oper&&(this.oper=this.to(t.oper),this.setEnvViaOperate(this.oper)),this.globals=t.globals||globals,t.option&&(this.option=t.option=_.extend({},this.option||{},t.option)),this.cfg=_.extend(this.cfg,t))},t.prototype.getConfig=function(){return this.cfg||{}},t.prototype.isConfig=function(t){return t&&t.option},t.prototype.add=function(e){var n,o=_.omit(this.getConfig(),"option");if(e instanceof t)n=e,n.parent&&n.parent.remove(n),n.setConfig(_.extend({},o,n.getConfig()));else{var r=this.isConfig(e)?e:{option:e};r=_.extend({},o,r),n=this.createContext(r)}return n.parent=this,this.children.push(n),n},t.prototype.createContext=function(e){return new t(e)},t.prototype.remove=function(t){var e=_.remove(this.children,t);return _.each(e,function(t){t&&(t.parent=null)}),e},t.prototype.isTask=function(t){return!!t&&(!!_.isFunction(t)&&(t.__task||t.__dynamictask))},t.prototype.find=function(t,e){var n;return this.each(function(e){if(n)return!1;var o=_.isFunction(t)?t(e):t===e;return!o||(n=e,!1)},e),n},t.prototype.filter=function(t,e){var n=[];return this.each(function(e){t(e)&&n.push(e)},e),n},t.prototype.each=function(t,e){e=e||TaskConfig_1.Mode.traverse;var n;switch(e){case TaskConfig_1.Mode.route:n=this.route(t);break;case TaskConfig_1.Mode.children:n=this.eachChildren(t);break;case TaskConfig_1.Mode.traverse:n=this.trans(t);break;default:n=this.trans(t)}return n},t.prototype.map=function(t,e,n){var o=[];return this.each(function(e){n?n(e)&&o.push(t(e)):o.push(t(e))},e),o},t.prototype.eachChildren=function(t){_.each(this.children,function(e){return t(e)})},t.prototype.route=function(t){return t(this)!==!1&&(this.parent&&this.parent.route?this.parent.route(t):void 0)},t.prototype.trans=function(t){return t(this)!==!1&&(_.each(this.children,function(e){return e.trans(t)}),!0)},t.prototype.matchCompare=function(t,e){return this.option.match?this.option.match(t,e):utils_1.matchCompare(this,t,e)},t.prototype.getSrc=function(t,e){void 0===e&&(e=!1);var n,o=this,r=this.to(t?t.oper||o.oper:o.oper);return t&&t.assert&&(n=taskSourceVal(getAssertSrc(t.assert,r),o)),n||this.route(function(t){return n=taskSourceVal(getAssertSrc(t.option,r),t),!n}),e!==!1?n:utils_1.absoluteSrc(o.env.root,n)},t.prototype.getDist=function(t,e){void 0===e&&(e=!1);var n,o=this;return t&&t.assert&&(n=getCurrentDist(t.assert,o)),n||this.route(function(t){return n=getCurrentDist(t.option,t),!n}),e!==!1?n:utils_1.absolutePath(o.env.root,n)},t.prototype.subTaskName=function(t,e){return this.taskName(t,e)},t.prototype.taskName=function(t,e){void 0===e&&(e="");var n=this,o="",r=_.filter(this.map(function(t){return t.toStr(t.option.name)},TaskConfig_1.Mode.route),function(t){return!!t}).reverse();return _.isString(t)||_.isFunction(t)?o=this.toStr(t):t&&t!==n.option&&(t.name&&(o=taskStringVal(t.name,n)),!o&&t.assert&&t.assert.name&&(o=taskStringVal(t.assert.name,n))),o||(o=n.toStr(n.option.defaultTaskName)),o&&r.push(o),e&&r.push(e),r.join("-")},t.prototype.findTasks=function(t,e){var n={};return this.env.group&&(n.group=this.env.group),this.oper&&(n.oper=this.oper),findTasks_1.findTasksInModule(t,_.extend(n,e||{}),this)},t.prototype.findTasksInDir=function(t,e){var n={};return this.env.group&&(n.group=this.env.group),this.oper&&(n.oper=this.oper),findTasks_1.findTasksInDir(this.to(t),_.extend(n,e||{}),this)},t.prototype.findTaskDefine=function(t){return findTasks_1.findTaskDefineInModule(t)},t.prototype.findTaskDefineInDir=function(t){return findTasks_1.findTaskDefineInDir(this.to(t))},t.prototype.fileFilter=function(t,e,n){return files(t,e,n)},t.prototype.toSequence=function(t,e){return taskSequence_1.toSequence(this.gulp,t,this,e)},t.prototype.runSequence=function(t){return taskSequence_1.runSequence(this.gulp,t)},t.prototype.runTaskSequence=function(t,e){return taskSequence_1.runTaskSequence(this.gulp,t,this,e)},t.prototype.zipSequence=function(t,e){return taskSequence_1.zipSequence(this.gulp,t,this,e)},t.prototype.flattenSequence=function(t,e){return taskSequence_1.flattenSequence(this.gulp,t,this,e)},t.prototype.generateTask=function(t,e){var n=this,o=generateTask_1.generateTask(this,t,_.extend({oper:n.oper},e||{}));return this.taskseq=this.taskseq.concat(o),this.taskseq},t.prototype.addToSequence=function(t,e){return this.cfg.addToSequence?this.cfg.addToSequence(t,e):taskSequence_1.addToSequence(t,e,this)},t.prototype.getRootPath=function(){var t,e=this;return this.env&&this.env.root?t=this.env.root:this.each(function(n){return!n.env||!n.env.root||(t=e.env.root,!1)},TaskConfig_1.Mode.route),t},t.prototype.getRootFolders=function(t){return this.getFolders(this.getRootPath(),t)},t.prototype.getFolders=function(t,e){var n=this,o=fs.readdirSync(t),r=[];return _.each(o,function(o){var i=path.join(t,o),s=fs.lstatSync(i);if(s.isDirectory())if(e){var a=e(i,o,n);a&&r.push(a)}else r.push(i)}),r},t.prototype.getDistFolders=function(t,e){return this.getFolders(this.getDist(e),t)},t.prototype.toRootSrc=function(t){return utils_1.absoluteSrc(this.getRootPath(),t)},t.prototype.toRootPath=function(t){return utils_1.absolutePath(this.getRootPath(),t)},t.prototype.toDistSrc=function(t,e){return utils_1.absoluteSrc(this.getDist(e),t)},t.prototype.toDistPath=function(t,e){return utils_1.absolutePath(this.getDist(e),t)},t.prototype.to=function(t){return _.isFunction(t)?t(this):t},t.prototype.toSrc=function(t){return taskSourceVal(t,this)},t.prototype.toStr=function(t){return taskStringVal(t,this)},t.prototype.toUrl=function(t,e){return(e?path.relative(t,e):t).replace(/\\/g,"/")},t.prototype.getPackage=function(t){t=t||this.cfg.packageFile;var e=this.toRootPath(this.toStr(t)||"package.json");return this.packages[e]||(this.packages[e]=require(e)),this.packages[e]},t.prototype.setupChildren=function(){return Promise.all(this.map(function(t){return t.setup().then(function(e){return t})},TaskConfig_1.Mode.children))},t.prototype.setup=function(){var t=this;return this.option.oper&&(this.oper&this.to(this.option.oper))<=0?Promise.resolve(null):Promise.resolve(this.load()).then(function(e){return t.setupChildren().then(function(t){return{tseq:e,subtasks:t}})}).then(function(e){var n=t.option,o=e.tseq,r=utils_1.sortOrder(e.subtasks,function(t){return t.option.order},t),i=[];return _.each(r,function(e,n){if(_.isArray(e)){if(e.length>0){var o=_.filter(_.map(e,function(e){return t.zipSequence(e.getRunSequence())}),function(t){return!!t});o.length>0&&i.push(o)}}else{var r=t.zipSequence(e.getRunSequence());r&&i.push(r)}}),i=t.flattenSequence(i),o=t.flattenSequence(o),o.length>0?(o=n.runWay===TaskConfig_1.RunWay.parallel?[t.flattenSequence(o)]:t.flattenSequence(o),i&&i.length>0&&(n.nodeSequence===TaskConfig_1.NodeSequence.after?o.splice.apply(o,[0,0].concat(i)):o.push.apply(o,i))):o=i,t.sequence=o,t.sequence})},t.prototype.getRunSequence=function(){return this.sequence||[]},t.prototype.load=function(){var t=this;return this.builder.isBuilt(this)?this.toSequence(this.taskseq):Promise.resolve(this.builder.build(this)).then(function(e){return t.toSequence(t.taskseq)})},t.prototype.addTask=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];(n=this.taskseq).push.apply(n,t);var n},t.prototype.removeTask=function(t){var e=this.taskseq.indexOf(t);return e>=0&&e<this.taskseq.length?this.taskseq.splice(e,1):[]},t.prototype.run=function(){var t=this;return this.env.help?Promise.resolve(this.help()):this.setup().then(function(e){var n=t.option;return n.runWay===TaskConfig_1.RunWay.parallel?t.runSequence([t.flattenSequence(e)]):t.runSequence(e)})},t.prototype.runDynamic=function(t,e){var n=this,o=utils_1.sortOrder(generateTask_1.generateTask(this,t,_.extend({oper:this.oper},e||{})),function(t){return t.getInfo().order},this),r=Promise.resolve();return _.each(o,function(t){r=r.then(function(){return _.isArray(t)?Promise.all(_.map(t,function(t){return t.execute?t.execute(n,n.gulp||gulp):null})):t.execute?t.execute(n,n.gulp||gulp):null})}),r},t.prototype.execShell=function(t,e,n){return void 0===n&&(n=!0),t?new Promise(function(o,r){console.log("execute shell:",chalk.cyan(t));var i=child_process_1.exec(t,e,function(t,e,n){t?r(t):o(e)});i.stdout.on("data",function(t){console.log(t)}),i.stderr.on("data",function(t){console.log(t),n||r(t)}),i.on("exit",function(t){console.log("exit child process with code："+t),t>0&&r(t)})}):Promise.resolve()},t.prototype.execFile=function(t,e,n,o){return void 0===o&&(o=!0),t||fs.existsSync(t)?new Promise(function(r,i){console.log("execute shell:",chalk.cyan(t));var s=child_process_1.execFile(t,e,n,function(t,e,n){t?i(t):r(e)});s.stdout.on("data",function(t){console.log(t)}),s.stderr.on("data",function(t){console.log(t),o||i(t)}),s.on("exit",function(t){console.log("exit child process with code："+t),t>0&&i(t)})}):(console.log("file:",chalk.yellow(t),"no exists."),Promise.resolve())},t.prototype.help=function(){this.cfg.printHelp&&this.cfg.printHelp(_.isBoolean(this.env.help)?"":this.env.help)},t.prototype.tasks=function(t){return t?_.filter(this.taskseq,t):this.taskseq},t.prototype.registerTasks=function(t){var e=[];return this.each(function(n){e=e.concat(n.tasks(t))}),e},t.prototype.globalTasks=function(){return _.keys(this.globals.tasks||{})},t}();exports.TaskContext=TaskContext;
//# sourceMappingURL=sourcemaps/TaskContext.js.map
