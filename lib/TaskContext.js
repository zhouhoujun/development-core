"use strict";function bindingConfig(e,t){return createContext(e,t)}function createContext(e,t){var n=e&&e.option?e:{option:e};return n.createContext?n.createContext(e,t):t?t.add(n):new TaskContext(n)}function currentOperation(e){var t;return t=e.deploy?Operation_1.Operation.deploy|Operation_1.Operation.release:e.release?Operation_1.Operation.release:Operation_1.Operation.build,e.watch&&(t|=Operation_1.Operation.watch),e.test&&(t|=Operation_1.Operation.test),e.serve&&(t|=Operation_1.Operation.serve),e.e2e&&(t|=Operation_1.Operation.e2e),t}function getAssertSrc(e,t){var n=null;return(t&Operation_1.Operation.test)>0?n=e.testSrc:(t&Operation_1.Operation.e2e)>0?n=e.e2eSrc:(t&Operation_1.Operation.watch)>0?n=e.watchSrc:(t&Operation_1.Operation.clean)>0&&(n=e.cleanSrc||e.dist),n||e.src}function getCurrentDist(e,t){var n,r=t.env,o=t.oper;return(r.deploy||(o&Operation_1.Operation.deploy)>0)&&(n=taskStringVal(e.deployDist,t)),!n&&(r.release||(o&Operation_1.Operation.release)>0)&&(n=taskStringVal(e.releaseDist,t)),!n&&(r.e2e||(o&Operation_1.Operation.e2e)>0)&&(n=taskStringVal(e.e2eDist,t)),!n&&(r.test||(o&Operation_1.Operation.test)>0)&&(n=taskStringVal(e.testDist,t)),!n&&(o&Operation_1.Operation.build)>0&&(n=taskStringVal(e.buildDist,t)),n||(n=taskStringVal(e.dist,t)),n}function files(e,t,n){return Promise.resolve(globby(e)).then(function(e){return t&&(e=_.filter(e,t)),n&&(e=_.map(e,n)),e})}function taskSourceVal(e,t){return _.isFunction(e)?e(t):e||""}function taskStringVal(e,t){return _.isFunction(e)?e(t):e||""}Object.defineProperty(exports,"__esModule",{value:!0});var _=require("lodash"),gulp=require("gulp"),chalk=require("chalk"),child_process_1=require("child_process"),minimist=require("minimist"),generateTask_1=require("./generateTask"),taskSequence_1=require("./taskSequence"),sortOrder_1=require("./utils/sortOrder"),match_1=require("./utils/match"),absolute_1=require("./utils/absolute"),findTasks_1=require("./findTasks"),path=require("path"),fs=require("fs"),Operation_1=require("./Operation"),Mode_1=require("./Mode"),RunWay_1=require("./RunWay"),NodeSequence_1=require("./NodeSequence"),globby=require("globby");exports.bindingConfig=bindingConfig,exports.createContext=createContext;var NULLBuilder={build:function(e,t){return e},isBuilt:function(e){return!1}},globals={},packages={},TaskContext=function(){function e(e){this.taskseq=[],this.sequence=[],this.children=[],e=e||{},e.env=e.env||this.createEnv(),this.setConfig(e)}return Object.defineProperty(e.prototype,"gulp",{get:function(){return this._gulp||gulp},set:function(e){this._gulp=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"builder",{get:function(){return this._builder||NULLBuilder},set:function(e){this._builder=e},enumerable:!0,configurable:!0}),e.prototype.createEnv=function(){var e=minimist(process.argv.slice(2),{string:"env",default:{env:process.env.NODE_ENV||"development"}});return e},e.prototype.setEnvViaOperate=function(e){this.env=this.env||{},(e&Operation_1.Operation.deploy)>0?(this.env.deploy=!0,this.env.release=void 0):(e&Operation_1.Operation.release)>0&&(this.env.release=!0,this.env.deploy=void 0,e=Operation_1.Operation.release),(e&Operation_1.Operation.watch)>0&&(this.env.watch=!0),(e&Operation_1.Operation.test)>0&&(this.env.test=!0),(e&Operation_1.Operation.serve)>0&&(this.env.serve=!0),(e&Operation_1.Operation.e2e)>0&&(this.env.e2e=!0)},e.prototype.setConfig=function(e){e&&(e.env&&(this.env=e.env=_.extend({},this.env||{},e.env),this.oper=currentOperation(this.env)),this.env.root||(this.env.root=this.getRootPath()),e.oper&&(this.oper=this.to(e.oper),this.setEnvViaOperate(this.oper)),this.globals=e.globals||globals,e.option&&(this.option=e.option=_.extend({},this.option||{},e.option)),this.cfg=_.extend(this.cfg,e))},e.prototype.getConfig=function(){return this.cfg||{}},e.prototype.isConfig=function(e){return e&&e.option},e.prototype.add=function(t){var n,r=_.omit(this.getConfig(),"option");if(t instanceof e)n=t,n.parent&&n.parent.remove(n),n.setConfig(_.extend({},r,n.getConfig()));else{var o=this.isConfig(t)?t:{option:t};o=_.extend({},r,o),n=this.createContext(o)}return n.parent=this,this.children.push(n),n},e.prototype.createContext=function(t){return new e(t)},e.prototype.remove=function(e){var t=_.remove(this.children,e);return _.each(t,function(e){e&&(e.parent=null)}),t},e.prototype.isTask=function(e){return!!e&&(!!_.isFunction(e)&&(e.__task||e.__dynamictask))},e.prototype.find=function(e,t){var n;return this.each(function(t){if(n)return!1;var r=_.isFunction(e)?e(t):e===t;return!r||(n=t,!1)},t),n},e.prototype.filter=function(e,t){var n=[];return this.each(function(t){e(t)&&n.push(t)},t),n},e.prototype.each=function(e,t){t=t||Mode_1.Mode.traverse;var n;switch(t){case Mode_1.Mode.route:n=this.route(e);break;case Mode_1.Mode.children:n=this.eachChildren(e);break;case Mode_1.Mode.traverse:n=this.trans(e);break;default:n=this.trans(e)}return n},e.prototype.map=function(e,t,n){var r=[];return this.each(function(t){n?n(t)&&r.push(e(t)):r.push(e(t))},t),r},e.prototype.eachChildren=function(e){_.each(this.children,function(t){return e(t)})},e.prototype.route=function(e){return e(this)!==!1&&(this.parent&&this.parent.route?this.parent.route(e):void 0)},e.prototype.trans=function(e){return e(this)!==!1&&(_.each(this.children,function(t){return t.trans(e)}),!0)},e.prototype.matchCompare=function(e,t){return this.option.match?this.option.match(e,t):match_1.matchCompare(this,e,t)},e.prototype.getSrc=function(e,t){void 0===t&&(t=!1);var n,r=this,o=this.to(e?e.oper||r.oper:r.oper);return e&&e.assert&&(n=taskSourceVal(getAssertSrc(e.assert,o),r)),n||this.route(function(e){return n=taskSourceVal(getAssertSrc(e.option,o),e),!n}),t!==!1?n:absolute_1.absoluteSrc(r.env.root,n)},e.prototype.getDist=function(e,t){void 0===t&&(t=!1);var n,r=this;return e&&e.assert&&(n=getCurrentDist(e.assert,r)),n||this.route(function(e){return n=getCurrentDist(e.option,e),!n}),t!==!1?n:absolute_1.absolutePath(r.env.root,n)},e.prototype.subTaskName=function(e,t){return this.taskName(e,t)},e.prototype.taskName=function(e,t){void 0===t&&(t="");var n=this,r="",o=_.filter(this.map(function(e){return e.toStr(e.option.name)},Mode_1.Mode.route),function(e){return!!e}).reverse();if(_.isString(e)||_.isFunction(e))r=this.toStr(e);else if(e&&e!==n.option){e.name&&(r=taskStringVal(e.name,n)),!r&&e.assert&&e.assert.name&&(r=taskStringVal(e.assert.name,n))}return r||(r=n.toStr(n.option.defaultTaskName)),r&&o.push(r),t&&o.push(t),o.join("-")},e.prototype.findTasks=function(e,t){var n={};return this.env.group&&(n.group=this.env.group),this.oper&&(n.oper=this.oper),findTasks_1.findTasksInModule(e,_.extend(n,t||{}),this)},e.prototype.findTasksInDir=function(e,t){var n={};return this.env.group&&(n.group=this.env.group),this.oper&&(n.oper=this.oper),findTasks_1.findTasksInDir(this.to(e),_.extend(n,t||{}),this)},e.prototype.findTaskDefine=function(e){return findTasks_1.findTaskDefineInModule(e)},e.prototype.findTaskDefineInDir=function(e){return findTasks_1.findTaskDefineInDir(this.to(e))},e.prototype.fileFilter=function(e,t,n){return files(e,t,n)},e.prototype.toSequence=function(e,t){return taskSequence_1.toSequence(this.gulp,e,this,t)},e.prototype.runSequence=function(e){return taskSequence_1.runSequence(this.gulp,e)},e.prototype.runTaskSequence=function(e,t){return taskSequence_1.runTaskSequence(this.gulp,e,this,t)},e.prototype.zipSequence=function(e,t){return taskSequence_1.zipSequence(this.gulp,e,this,t)},e.prototype.flattenSequence=function(e,t){return taskSequence_1.flattenSequence(this.gulp,e,this,t)},e.prototype.generateTask=function(e,t){var n=this,r=generateTask_1.generateTask(this,e,_.extend({oper:n.oper},t||{}));return this.taskseq=this.taskseq.concat(r),this.taskseq},e.prototype.addToSequence=function(e,t){return this.cfg.addToSequence?this.cfg.addToSequence(e,t):taskSequence_1.addToSequence(e,t,this)},e.prototype.getRootPath=function(){var e,t=this;return this.env&&this.env.root?e=this.env.root:this.each(function(n){return!n.env||!n.env.root||(e=t.env.root,!1)},Mode_1.Mode.route),e},e.prototype.getRootFolders=function(e){return this.getFolders(this.getRootPath(),e)},e.prototype.getFolders=function(e,t){var n=this,r=fs.readdirSync(e),o=[];return _.each(r,function(r){var i=path.join(e,r),s=fs.lstatSync(i);if(s.isDirectory())if(t){var u=t(i,r,n);u&&o.push(u)}else o.push(i)}),o},e.prototype.getDistFolders=function(e,t){return this.getFolders(this.getDist(t),e)},e.prototype.toRootSrc=function(e){return absolute_1.absoluteSrc(this.getRootPath(),e)},e.prototype.toRootPath=function(e){return absolute_1.absolutePath(this.getRootPath(),e)},e.prototype.toDistSrc=function(e,t){return absolute_1.absoluteSrc(this.getDist(t),e)},e.prototype.toDistPath=function(e,t){return absolute_1.absolutePath(this.getDist(t),e)},e.prototype.to=function(e){return _.isFunction(e)?e(this):e},e.prototype.toSrc=function(e){return taskSourceVal(e,this)},e.prototype.toStr=function(e){return taskStringVal(e,this)},e.prototype.toUrl=function(e,t){return(t?path.relative(e,t):e).replace(/\\/g,"/")},e.prototype.getPackage=function(e){e=e||this.cfg.packageFile;var t=this.toRootPath(this.toStr(e)||"package.json");return packages[t]||(packages[t]=require(t)),packages[t]},e.prototype.getNpmModuleVersion=function(e,t){var n=this.getPackage(t);if(!n)return"";var r="";return n.dependencies&&(r=n.dependencies[e]),!r&&n.devDependencies&&(r=n.devDependencies[e]),r||""},e.prototype.hasNpmModule=function(e,t){return""!==this.getNpmModuleVersion(e,t)},e.prototype.setupChildren=function(){return Promise.all(this.map(function(e){return e.setup().then(function(t){return e})},Mode_1.Mode.children))},e.prototype.setup=function(){var e=this;return this.option.oper&&(this.oper&this.to(this.option.oper))<=0?Promise.resolve(null):Promise.resolve(this.load()).then(function(t){return e.setupChildren().then(function(e){return{tseq:t,subtasks:e}})}).then(function(t){var n=e.option,r=t.tseq,o=sortOrder_1.sortOrder(t.subtasks,function(e){return e.option.order},e),i=[];return _.each(o,function(t,n){if(_.isArray(t)){if(t.length>0){var r=_.filter(_.map(t,function(t){return e.zipSequence(t.getRunSequence())}),function(e){return!!e});r.length>0&&i.push(r)}}else{var o=e.zipSequence(t.getRunSequence());o&&i.push(o)}}),i=e.flattenSequence(i),r=e.flattenSequence(r),r.length>0?(r=n.runWay===RunWay_1.RunWay.parallel?[e.flattenSequence(r)]:e.flattenSequence(r),i&&i.length>0&&(n.nodeSequence===NodeSequence_1.NodeSequence.after?r.splice.apply(r,[0,0].concat(i)):r.push.apply(r,i))):r=i,e.sequence=r,e.sequence})},e.prototype.getRunSequence=function(){return this.sequence||[]},e.prototype.load=function(){var e=this;return this.builder.isBuilt(this)?this.toSequence(this.taskseq):Promise.resolve(this.builder.build(this)).then(function(t){return e.toSequence(e.taskseq)})},e.prototype.addTask=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];(n=this.taskseq).push.apply(n,e);var n},e.prototype.removeTask=function(e){var t=this.taskseq.indexOf(e);return t>=0&&t<this.taskseq.length?this.taskseq.splice(t,1):[]},e.prototype.run=function(){var e=this;return this.env.help?Promise.resolve(this.help()):this.setup().then(function(t){var n=e.option;return n.runWay===RunWay_1.RunWay.parallel?e.runSequence([e.flattenSequence(t)]):e.runSequence(t)})},e.prototype.runDynamic=function(e,t){var n=this,r=sortOrder_1.sortOrder(generateTask_1.generateTask(this,e,_.extend({oper:this.oper},t||{})),function(e){return e.getInfo().order},this),o=Promise.resolve();return _.each(r,function(e){o=o.then(function(){return _.isArray(e)?Promise.all(_.map(e,function(e){return e.execute?e.execute(n,n.gulp||gulp):null})):e.execute?e.execute(n,n.gulp||gulp):null})}),o},e.prototype.execShell=function(e,t,n){return void 0===n&&(n=!0),e?new Promise(function(r,o){console.log("execute shell:",chalk.cyan(e));var i=child_process_1.exec(e,t,function(e,t,n){e?o(e):r(t)});i.stdout.on("data",function(e){console.log(e)}),i.stderr.on("data",function(e){console.log(e),n||o(e)}),i.on("exit",function(e){console.log("exit child process with code："+e),e>0&&o(e)})}):Promise.resolve()},e.prototype.execFile=function(e,t,n,r){return void 0===r&&(r=!0),e||fs.existsSync(e)?new Promise(function(o,i){console.log("execute shell:",chalk.cyan(e));var s=child_process_1.execFile(e,t,n,function(e,t,n){e?i(e):o(t)});s.stdout.on("data",function(e){console.log(e)}),s.stderr.on("data",function(e){console.log(e),r||i(e)}),s.on("exit",function(e){console.log("exit child process with code："+e),e>0&&i(e)})}):(console.log("file:",chalk.yellow(e),"no exists."),Promise.resolve())},e.prototype.help=function(){this.cfg.printHelp&&this.cfg.printHelp(_.isBoolean(this.env.help)?"":this.env.help)},e.prototype.tasks=function(e){return e?_.filter(this.taskseq,e):this.taskseq},e.prototype.registerTasks=function(e){var t=[];return this.each(function(n){t=t.concat(n.tasks(e))}),t},e.prototype.globalTasks=function(){return _.keys(this.globals.tasks||{})},e}();exports.TaskContext=TaskContext;
//# sourceMappingURL=sourcemaps/TaskContext.js.map
